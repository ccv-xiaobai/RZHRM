###  项目架构和解决方案
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677638069702-b1d74f78-3c4d-4491-bbcb-5984cd6a2740.png#averageHue=%23526a27&clientId=u27a6c102-7f89-4&from=paste&height=529&id=ub74513ae&name=image.png&originHeight=1058&originWidth=2164&originalType=binary&ratio=2&rotation=0&showTitle=false&size=236996&status=done&style=none&taskId=u8aa4e64f-2e8e-46fc-b2eb-bbc40084251&title=&width=1082)



### 课程具备能力

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677638817350-1233e8af-2c01-419d-ae0b-21fd71338458.png#averageHue=%2394bd4b&clientId=ud3ec7d2a-274d-4&from=paste&height=619&id=u0de52d47&name=image.png&originHeight=1238&originWidth=2758&originalType=binary&ratio=2&rotation=0&showTitle=false&size=293029&status=done&style=none&taskId=u42e4b301-34e9-4f99-859f-c5d6d34b3f3&title=&width=1379)



# 登录模块

**页面结构和表单**

```vue
<template>
  <div class="login-container">
      
    <div class="bg-circle">
      <img class="lt" src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u3.png" alt="">
      <img class="lb" src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u5.png" alt="">
      <img class="rt" src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u4.png" alt="">
    </div>
      
    <div class="main">
      <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u25.png" alt="">
        
      <el-card shadow="never">
        <div class="title">
          <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u24.png" alt="">
          <h2>人力资源后台管理</h2>
        </div>
          
        <!--登录表单-->
        <el-form>
          <el-form-item>
            <el-input placeholder="请输入手机号">
              <template #prefix>
                <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u13.png" alt="">
              </template>
            </el-input>
          </el-form-item>

          <el-form-item>
            <el-input placeholder="请输入密码">
              <template #prefix>
                <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u17.png" alt="">
              </template>
            </el-input>
          </el-form-item>

          <el-form-item>
            <el-input placeholder="请输入验证码">
              <template #prefix>
                <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u21.png" alt="">
              </template>
              <template #append>
                <span>9 5 2 8</span>
              </template>
            </el-input>
          </el-form-item>

          <el-form-item>
            <el-checkbox>用户平台使用协议</el-checkbox>
          </el-form-item>

          <el-form-item>
            <el-button type="primary" class="login-btn" @click="loginClick">登录</el-button>
          </el-form-item>

        </el-form>

      </el-card>
    </div>
  </div>
</template>

```

**页面样式**

```scss
<style scoped lang="scss">
.login-container {
  position: relative;
  height: 100%;
  background-image: linear-gradient(#3fccfd, #996cfb);
  overflow: hidden;

  // 三个圆形图片的位置
  .bg-circle {
    .lt {
      position: absolute;
      left: 40px;
      top: 40px;
      opacity: 0.3;
    }
    .lb {
      position: absolute;
      left: -250px;
      bottom: -200px;
    }
    .rt {
      position: absolute;
      right: -70px;
      top: -200px;
    }
  }

  // 主体内容
  .main {
    // 水平和垂直居中
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;

    // 登录卡片
    .el-card {
      margin-left: 60px;

      // 卡片标题
      .title {
        display: flex;
        justify-content: center;
        align-items: center;

        font-size: 23px;
        font-weight: 700;
        font-style: normal;
        color: rgb(67, 141, 238);

        img {
          width: 50px;
          height: 42px;
        }
      }

      // 登录表单文本框
      .el-input {
        width: 350px;
        height: 44px;

        // 文本框内容
        ::v-deep .el-input__inner {
          background-color: #f4f5fb;
          height: 44px;
        }

        // 文本框头部图标样式
        img {
          width: 20px;
          height: 20px;
          margin-top: 12px;
        }

        // 文本框尾部验证码样式
        ::v-deep .el-input-group__append {
          font-family: 'Arial Negreta', 'Arial Normal', 'Arial';
          font-weight: 700;
          font-size: 16px;
          color: #FF7733;
          // height: 44px;
        }
      }

      // 复选款样式
      .el-checkbox {
        color:#606266;
      }

      // 登录按钮样式
      .login-btn {
        width: 350px;
      }
    }
  }
}
</style>

```



### **表单校验和登录请求**

**表单校验**

- 登录数据对象绑定表单

  ```html
  <!--登录表单-->
  <el-form ref="loginForm" :model="loginForm" :rules="loginRules">
    <el-form-item prop="mobile">
      <el-input v-model="loginForm.mobile" placeholder="请输入手机号">
        <template #prefix>
          <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u13.png" alt="">
        </template>
      </el-input>
    </el-form-item>
    <el-form-item prop="password">  <!-- show-password 显示密文 -->
      <el-input v-model="loginForm.password" show-password  placeholder="请输入密码">
        <template #prefix>
          <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u17.png" alt="">
        </template>
      </el-input>
    </el-form-item>
    <el-form-item prop="code">
      <el-input v-model="loginForm.code" placeholder="请输入验证码">
        <template #prefix>
          <img src="https://img.axureshop.com/7a/4a/a8/7a4aa826e79b40d086fba67fb100e0f9/images/0登陆页/u21.png" alt="">
        </template>
        <template #append>
          <span>9 5 2 8</span>
        </template>
      </el-input>
    </el-form-item>
    <el-form-item prop="isAgree">
      <el-checkbox v-model="loginForm.isAgree">用户平台使用协议</el-checkbox>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" class="login-btn" @click="loginClick">登录</el-button>
    </el-form-item>
  </el-form>
  ```

- 定义登录表单数据对象和校验规则

  ```js
  <script>
  export default {
    data() {
      return {
        // 登录信息
        loginForm: {
          mobile: '',  // 手机号
          password: '',  // 密码
          isAgree: false, // 是否勾选
          code: ''      // 验证码
        },
        // 校验规则
        loginRules: {
          mobile: [
            { required: true, message: '手机号不能为空', trigger: 'blur' },
            { pattern: /^1[3-9]\d{9}$/, message: '手机号格式不正确', trigger: 'blur' }
          ],
          password: [
            { required: true, message: '密码不能为空', trigger: 'blur' },
            { min: 6, max: 16, message: '密码长度6-16位', trigger: 'blur' }
          ],
          isAgree: [
            {
              // 自定义校验函数(校验规则, 要校验的值, 成功或失败的回调函数)
              validator: (rule, value, callback) => {
                // rule 检验规则
                // value 校验的值
                // callback 函数
                // 成功执行callback 失败也执行callback(错误对象 new Error(错误信息))
                value ? callback() : callback(new Error('未勾选用户协议'))
              }
            }
          ],
          code: [
            { required: true, message: '验证码不能为空', trigger: 'blur' },
            { pattern: /^\d{4}$/, message: '验证码是四位数字', trigger: 'blur' }
          ]
        }
      }
  },
  }
  </script>
  ```

  

**登录请求**

- 登录按钮注册点击事件：`@click="loginClick"`

  ```html
  <el-form-item>
    <el-button type="primary" class="login-btn" @click="loginClick">登录</el-button>
  </el-form-item>
  ```

- 整体校验并发送登录请求

  ```js
  <script>
  export default {
    data() {
      return {
        ......
      }
    },
    methods: {
      // 登录提交
      async loginClick() {
          // this.$refs.loginForm.validate((isOK) => {
          //     if(isOK) { 通过校验 跳转 }
          //})
        const res = await this.$refs.loginForm.validate()
        if (res) {
          // Vuex的actions返回的是Promiss对象
          await this.$store.dispatch('user/login', this.loginForm)
          // 如果登录成功，跳转到首页
          this.$router.push('/')
        }
      }
    }
  }
  </script>
  ```



> 备用的登录信息

```js
// 登录信息
loginForm: {
  mobile: process.env.NODE_ENV === 'development' ? '13800000002' : '',
    password: process.env.NODE_ENV === 'development' ? 'hm#qd@23!' : '',
      isAgree: process.env.NODE_ENV === 'development',
        code: process.env.NODE_ENV === 'development' ? '1274' : ''
},
```

​    

### 分析登录流程

> 传统思路都是登录校验通过之后，直接调用接口，获取token之后，跳转到主页。

- **vue-element-admin的登录思路：**

1. 登录表单校验通过
2. 调用Vuex提供的登录的action
3. 登录的Action中会调用接口
4. 登录接口如果成功执行，会返回token
5. 利用Vuex的特性，将token共享的到Vuex中，这样Vuex就统一管理了token,别的地方想要使用，直接通过Vuex就可以
6. 登录接口会调用单独封装的请求模块(api)
7. 请求模块中又会使用用到axios封装的请求工具
8. 而请求工具又要考虑区分 开发环境和生产环境的问题
9. 请求时还要考虑前后分离项目产生的跨域问题，要使用代理解决跨域



### `vuex`的持久化  `/modules/user.js`

```js
import { setToken, getToken, removeToken } from '@/utils/auth'
import { login, getUserInfo } from '@/api/user'

const state = {
  token: getToken() // 从缓存中读取初始值
}

const mutations = {
  // 修改token（登录操作）
  setToken(state, token) {
    state.token = token
    // 同步到缓存 （不同步页面一刷新就会丢失）
    setToken(token)
  },
    
  // 删除token（退出操作）
  removeToken(state) {
    // 删除Vuex的token
    state.token = null
    // 删除缓存
    removeToken()
  }
}
                                                    
const actions = {
  // context 上下文，传入参数
  login(context, data) {
    // console.log(data) // 已传入参数
    // todo ： 调用登陆接口
    const token = await login(data)
    // 接口返回一个token 把token进行共享
    // 提交
    context.commit('setToken', token)
  }
}

export default {
  namespaced: true, // 开启命名空间 所以我们调用action的时候要加上模块名称如**user/login**
  state,
  mutations,
  actions
}

```







### Vue-cli代理解决跨域（开发环境）

> **请求模块-axios封装-跨域-区分环境**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677661659053-a46470bb-38f9-4483-b685-d2f0236e57b0.png#averageHue=%23fdfdfd&clientId=u60b73d67-62d7-4&from=paste&height=489&id=u35c19420&name=image.png&originHeight=978&originWidth=2126&originalType=binary&ratio=2&rotation=0&showTitle=false&size=105804&status=done&style=none&taskId=u7a1f8bf3-efc3-423c-9e69-a4aa46593ee&title=&width=1063)

> 我们要先把跨域问题解决才能考虑其他内容的开发,否则请求接口是不通的。

- 首先为什么会有跨域？

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677662325286-e15c499c-44a2-47cc-a1ea-47ce323facaa.png#averageHue=%23fcfafa&clientId=u60b73d67-62d7-4&from=paste&height=192&id=u4817e2b5&name=image.png&originHeight=384&originWidth=2048&originalType=binary&ratio=2&rotation=0&showTitle=false&size=63802&status=done&style=none&taskId=u6b4945fa-b4cd-4b9f-8493-723a76b20e5&title=&width=1024)

> 在后端没有开启cors的情况下，浏览器的同源策略会直接限制后端返回的数据给到前端。这是因为我们目前所有的项目都是前后分离，前端一个服务， 后端一个服务，后端不开cors只能前端自己想办法。

- 代理是怎么解决跨域的？

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677662514280-7a5ed512-57e7-4de3-825d-d8c352d679ec.png#averageHue=%23fefdfd&clientId=u60b73d67-62d7-4&from=paste&height=237&id=u0b790914&name=image.png&originHeight=474&originWidth=2184&originalType=binary&ratio=2&rotation=0&showTitle=false&size=63966&status=done&style=none&taskId=u007d9723-528d-4b10-9bd6-3112c660518&title=&width=1092)

> 既然前端不能直接请求后端服务，那就搞个中间服务，中间服务刚好和我们的前端服务同源，前端和中间服务可以通信，而中间服务是node, node后台向后端发请求是不受同源策略影响的，因为**同源策略只针对浏览器！！！**， 这样就是代理，中间层的服务将前端的请求代理给了后端接口。


- 具体怎么做呢？

> 跨域有开发环境跨域和生产环境跨域，我们最后上线的时候要考虑生产环境跨域，目前只需要考虑开发环境。

- 配置文件可以直接配置代理 vue.config.js

```javascript
  devServer: {
    port: port,
    open: true,
    overlay: {
      warnings: false,
      errors: true
    },
    proxy: {
        // path: 目标服务器 百度 新浪 网易...改完重启服务器
        // /api:因为我们请求地址里有 /api
      '/api': {
        target: 'https://heimahr.itheima.net'    
      }
    }
      // 基础模板做的模拟数据，拦截请求
    // before: require('./mock/mock-server.js')
  },
      
// url:'/api/sys/login' => http://localhost:9528/api/sys/login => https://heimahr.itheima.net/api/sys/login
// 做了一个转发服务
      
// 有 /api 自动专向方向地址 所有基地址是 /api
```



### axios二次封装

> 完成了代理跨域，就可以考虑axios的封装了。

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677662862226-ebc76111-3217-4661-b28a-c8a9e0dd74f0.png#averageHue=%23fefefe&clientId=u60b73d67-62d7-4&from=paste&height=455&id=u171f33b0&name=image.png&originHeight=910&originWidth=2100&originalType=binary&ratio=2&rotation=0&showTitle=false&size=104541&status=done&style=none&taskId=u2e9c8f87-99d2-4f82-a8e0-8dbcc53c4d6&title=&width=1050)

> axios封装主要封装做哪些呢？

- 基础地址，超时时间
- 请求拦截器-统一注入token
- 响应拦截器-解构数据-处理异常

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677663057762-d0653812-73be-4885-a00c-50eaf3dee4cf.png#averageHue=%23fefefe&clientId=u60b73d67-62d7-4&from=paste&height=342&id=u88b463ee&name=image.png&originHeight=684&originWidth=2220&originalType=binary&ratio=2&rotation=0&showTitle=false&size=65900&status=done&style=none&taskId=ub38fd5da-3be4-4093-8c49-aa729540ae8&title=&width=1110)

- axios的基础功能

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677663248416-25147092-dcd4-46e1-bae4-1084ac8e73f7.png#averageHue=%23fdfdfd&clientId=u60b73d67-62d7-4&from=paste&height=472&id=u0ddd8983&name=image.png&originHeight=944&originWidth=2326&originalType=binary&ratio=2&rotation=0&showTitle=false&size=112419&status=done&style=none&taskId=uc141a243-4f29-46de-b123-8e55a3c6b0b&title=&width=1163)

代码位置(`src/utils/request.js`)

```javascript
import axios from 'axios'
import store from '@/store'
import { Message } from 'element-ui'

const service = axios.create({ // 创建一个新的axios实例
  baseURL: '/api', // 基础地址(因为反向代理了)
  timeout: 10000 // 超时时间 毫秒
}) 

// 请求拦截器
// 成功执行第一个，失败执行第二个
service.interceptors.request.use((config) => {
  // 请求接口  config是请求配置
  // 注入token
  // this.$getters.token  this组件实例，现在不是组件
  // store.getters.token => 请求头里面
  if (store.getters.token) {
    // 只要有token，就要检查token的时效性
    // 如果存在token，注入token
    config.headers.Authorization = `Bearer ${store.getters.token}`
  }

  // 一定要 return config ！！！！！！！
  return config
}, (error) => {
  // 失败执行promise
  return Promise.reject(error)
})

// 响应拦截器
service.interceptors.response.use((response) => {
  // 成功执行
  // axios默认包裹了一层data
  // 响应数据解构出来
  const { data, message, success } = response.data // 默认json格式
  if (success) {
    // 此时认为业务执行成功了
    return data // 返回用户所需要的数据
  } else {
    // 当业务失效的时候
    Message({ type: 'error', message }) // 提示消息
    return Promise.reject(new Error(message))
  }
}, async(error) => {
  // error.message
  // this 只能在组件里用
  Message({ type: 'error', message: error.message })
  return Promise.reject(error)
})

export default service

```

### 环境区分

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677667090171-7e569091-0544-49f4-9a22-7195ba55c0a9.png#averageHue=%23fcfbfa&clientId=u60b73d67-62d7-4&from=paste&height=472&id=ude3f8172&name=image.png&originHeight=944&originWidth=1924&originalType=binary&ratio=2&rotation=0&showTitle=false&size=101249&status=done&style=none&taskId=u8140d293-c9b4-4e82-b712-9b3215251a8&title=&width=962)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677667212785-bfc5de9c-ee4e-4ab8-9ea5-549a137f3c91.png#averageHue=%23faf8f7&clientId=u60b73d67-62d7-4&from=paste&height=462&id=u34f9b1c2&name=image.png&originHeight=924&originWidth=2288&originalType=binary&ratio=2&rotation=0&showTitle=false&size=246988&status=done&style=none&taskId=ucca3d918-64eb-486f-a922-0b4d238b77e&title=&width=1144)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677667227525-9d0d6876-080a-4938-a664-ed8e9f50f632.png#averageHue=%23fbf7f6&clientId=u60b73d67-62d7-4&from=paste&height=237&id=ub1cbea1a&name=image.png&originHeight=474&originWidth=2296&originalType=binary&ratio=2&rotation=0&showTitle=false&size=76755&status=done&style=none&taskId=u77d14dc1-31a4-4998-8a9c-8f4a45ba3e5&title=&width=1148)

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677667385734-95592eb6-e236-4b05-8e32-8c65df2367cd.png#averageHue=%23b6b6b6&clientId=u60b73d67-62d7-4&from=paste&height=261&id=u6858a56b&name=image.png&originHeight=522&originWidth=2386&originalType=binary&ratio=2&rotation=0&showTitle=false&size=163061&status=done&style=none&taskId=u6f71d26e-e56b-4507-b0c1-d89f7eab5f5&title=&width=1193)

- 将`.env.development`中的值改为` /api `作为请求工具的基础地址

  ```js
  // .env.development 开发环境
  # just a flag
  ENV = 'development'
  
  # base api
  VUE_APP_BASE_API = '/api'
  
  ```

- **`process.env.VUE_APP_BASE_API `**的表示读取该变量，yarn dev时该变量为 /api,  yarn build:prod时 该变量为 /prod-api

  ```js
  // .env.production 生产环境
  # just a flag
  ENV = 'production'
  
  # base api
  VUE_APP_BASE_API = '/prod-api'
  
  ```

  ​    

**登录联调**

> 目前登录功能只剩下红色的部分还需要

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677724539500-9e9b1f76-4220-4a35-aa55-539cab4e6993.png#averageHue=%23fdfdfd&clientId=u60b73d67-62d7-4&from=paste&height=525&id=u7f1c3b73&name=image.png&originHeight=1050&originWidth=2454&originalType=binary&ratio=2&rotation=0&showTitle=false&size=122291&status=done&style=none&taskId=u444becba-25d5-4f15-8ce8-df53b507e35&title=&width=1227)

- 区分不同环境的数据

> 因为开发环境为了便利，我们将用户的账户信息和密码都默认写在了页面上，但是真正的项目我们不可能将数据进行暴露出去，所以在生产环境时应该将 用户的手机号和密码抹去

```javascript
export default {
  name: 'Login',
  data() {
    return {
       loginForm: {
        mobile: process.env.NODE_ENV === 'development' ? '13800000002' : '',
        password: process.env.NODE_ENV === 'development' ? 'hm#qd@23!' : '',
        isAgree: process.env.NODE_ENV === 'development',
        code: process.env.NODE_ENV === 'development' ? '1274' : ''
      },
    }
  }
}
```



# 主页模块

### 主页鉴权-主页权限验证

> 当前项目用户是否有权限访问主页，要考虑当前有没有token,  如果有token, 用户还想去登录页，我们可以直接去主页-这个就是免登录功能。有token的情况下，直接到主页。

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677725185117-bd3bdb5d-9ab0-498d-a8cf-9fabf878054e.png#averageHue=%23fcf8f3&clientId=u60b73d67-62d7-4&from=paste&height=510&id=ub052895c&name=image.png&originHeight=1020&originWidth=2602&originalType=binary&ratio=2&rotation=0&showTitle=false&size=128698&status=done&style=none&taskId=u94ebd235-1fc4-41ac-8abe-0de345cfade&title=&width=1301)

- 访问主页-有token放过，没有token跳到登录页
- 访问登录-有token跳到主页（不让跳转，只有退出登录），没有token放过

代码实现-代码位置(**src/pemission.js**)

```javascript
import router from '@/router'
import nprogress from 'nprogress'
import 'nprogress/nprogress.css'
import store from '@/store'


// 路由前置守卫
const whiteList = ['/login', '/404']
router.beforeEach(async(to, from, next) => {
    
  nprogress.start() // 开启进度条，路由跳转之前开启
    
  if (store.getters.token) {
    // 存在token
    if (to.path === '/login') {
      // 跳转到主页
      next('/') // 中转到主页
      // next（地址）并没有执行后置守卫
      nprogress.done()  // 手动关闭进度条
    } else {
       
        // 这里判断是否获取过资料 if(!store.getters.userId) store.dispath('user/getUserInfo')
       next() // 放行
    }
  } else {
    // 没有token
    if (whiteList.includes(to.path)) {
      next()
    } else {
      next('/login') // 中转到登录页
      nprogress.done()
    }
  }
})

// 路由后置守卫
router.afterEach(() => {
  nprogress.done() // done完成  关闭进度条
})

```





### 处理token失效的问题

> token是有时效性的，当token超时，我们需要做一下处理

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677727686990-34c65c07-f755-4553-92d8-7d2bf4c44bd2.png#averageHue=%23fcfcfc&clientId=udd47902c-ce16-4&from=paste&height=167&id=ub8c1ca74&name=image.png&originHeight=334&originWidth=2666&originalType=binary&ratio=2&rotation=0&showTitle=false&size=61012&status=done&style=none&taskId=u0ee16810-fe28-4268-a33c-c3a473a3db5&title=&width=1333)

- 请求拦截器处理-代码位置(**src/utils/request.js**)

```javascript
// 响应拦截器
service.interceptors.response.use(..., async(error) => {
    // console.log(error)
  if (error.response.status === 401) {
    Message({ type: 'warning', message: 'token超时了' })
    // 说明token超时了
    // 调用action中的退出登录
    await store.dispatch('user/logout') 
    //  主动跳到登录页
    router.push('/login') // 跳转到登录页
    return Promise.reject(error)
  }
  // error.message
  Message.error(error.message)
  return Promise.reject(error)
})
```

- 实现Vuex的登出action-代码位置(**src/store/modules/user.js**)

```javascript
const actions = {
  // 退出登录的action
  logout(context) {
    context.commit('removeToken') // 删除token
    context.commit('setUserInfo', {}) // 设置用户信息为空对象
  }
}
```





### 路由配置

![](img/路由.png)








### 解析左侧菜单原理

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677731478801-2152aa51-ceaf-4119-b12d-a9ff559c7064.png#averageHue=%2396bd4d&clientId=udd47902c-ce16-4&from=paste&height=351&id=uc38c0284&name=image.png&originHeight=702&originWidth=1824&originalType=binary&ratio=2&rotation=0&showTitle=false&size=62927&status=done&style=none&taskId=u4d3eba61-0397-4e5b-b4b0-9d78f889520&title=&width=912)

> **左侧菜单的数据来源于路由模块的信息， 会根据路由信息的hidden属性来判断是否显示该路由信息到菜单，**
> **菜单属性中的图表和标题来源于路由meta中的icon和title属性**


- 分析过程

sidebar组件引入路由信息
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677731592548-6450a3c2-c0f0-4ee3-a714-26717eef2c00.png#averageHue=%23282827&clientId=udd47902c-ce16-4&from=paste&height=253&id=u247a4fd7&name=image.png&originHeight=506&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2595497&status=done&style=none&taskId=u4ced5d02-67f0-4be4-a86c-88324c06edc&title=&width=640)
循环渲染路由信息
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677731608249-6b3fe1a3-dd74-4825-91ae-ed0c3f39933c.png#averageHue=%23212121&clientId=udd47902c-ce16-4&from=paste&height=192&id=u4bead679&name=image.png&originHeight=384&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1969728&status=done&style=none&taskId=u3ca43961-a16a-48e5-b824-9d7b8aa56b6&title=&width=640)
sidebarItem组件根据条件渲染-传递icon和title属性给item组件
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677731639959-05b555fb-24d3-4cd0-8afd-2afe3b4c2763.png#averageHue=%23292928&clientId=udd47902c-ce16-4&from=paste&height=122&id=uacbf4751&name=image.png&originHeight=244&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1251622&status=done&style=none&taskId=u1c0ba0bc-a751-454d-bd79-aaf923e704f&title=&width=640)
item组件接收icon和title属性，使用函数型组件完成渲染
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677731696023-0fab52a0-622f-487d-b7e9-8238d7b37150.png#averageHue=%23252524&clientId=udd47902c-ce16-4&from=paste&height=360&id=u9eef52e6&name=image.png&originHeight=720&originWidth=990&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2856615&status=done&style=none&taskId=ua28d4a1e-3729-4dd0-b79a-a2a4fd00389&title=&width=495)





# 进入行内编辑

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677752748383-1782735a-c06e-4870-bb74-6b90ae30b768.png#averageHue=%23fefefe&clientId=u437893ff-a4ad-4&from=paste&height=350&id=u02826ef4&name=image.png&originHeight=700&originWidth=2542&originalType=binary&ratio=2&rotation=0&showTitle=false&size=115772&status=done&style=none&taskId=u1952efda-2d03-4dbd-9087-7182c3f99e9&title=&width=1271)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677752762094-a0a67f8f-852d-4562-b351-e13bb19d5546.png#averageHue=%23c6daec&clientId=u437893ff-a4ad-4&from=paste&height=124&id=ue23dbb1e&name=image.png&originHeight=248&originWidth=2046&originalType=binary&ratio=2&rotation=0&showTitle=false&size=37554&status=done&style=none&taskId=u094ccf42-5d1a-4fdc-bf33-a8c74276aea&title=&width=1023)

- 获取数据之后针对每个数据定义标识-使用$set

```javascript
 // 针对每一行数据添加一个编辑标记
      this.list.forEach(item => {
        // item.isEdit = false // 添加一个属性 初始值为false
        // 数据响应式的问题  数据变化 视图更新
        // 添加的动态属性 不具备响应式特点
        // this.$set(目标对象, 属性名称, 初始值) 可以针对目标对象 添加的属性 添加响应式
        this.$set(item, 'isEdit', false)
      })
```

> 为什么不使用item.isEdit = false , 因为动态添加的属性不具备响应式的特点，如果想要具备响应式，可以使用$set


- 点击编辑时，将当前行的标记isEdit设置为true

```vue
<el-table-column align="center" label="操作">
    <template v-slot="{row}">
        <!-- 非编辑状态 -->
        <el-button size="mini" type="text">分配权限</el-button>
        <el-button size="mini" type="text" @click="btnEditRow(row)">编辑</el-button>
        <el-button size="mini" type="text">删除</el-button>
    </template>
</el-table-column>
```

- 点击编辑的方法

```javascript
    // 点击编辑行
    btnEditRow(row) {
      row.isEdit = true // 改变行的编辑状态
    }
```

- 表格列中根据当前的isEdit标记-渲染结构

```html
<el-table-column prop="name" align="center" width="200" label="角色">
      <template v-slot="{ row }">
        <!-- 条件判断 -->
        <el-input v-if="row.isEdit" size="mini" />
        <span v-else>{{ row.name }}</span>
      </template>
</el-table-column>
<el-table-column prop="state" align="center" width="200" label="启用">
          <!-- 自定义列结构 -->
    <template v-slot="{ row }">
        <el-switch v-if="row.isEdit" />
        <span v-else>  {{ row.state === 1 ? "已启用" : row.state === 0 ? "未启用" : "无" }} </span>
    </template>
</el-table-column>
<el-table-column prop="description" align="center" label="描述">
     <template v-slot="{ row }">
            <el-input v-if="row.isEdit" type="textarea" />
            <span v-else>{{ row.description }}</span>
      </template>
</el-table-column>
 <el-table-column align="center" label="操作">
    <template v-slot="{ row }">
        <template v-if="row.isEdit">
            <!-- 编辑状态 -->
            <el-button type="primary" size="mini">确定</el-button>
            <el-button size="mini">取消</el-button>
        </template>
        <template v-else>
              <!-- 非编辑状态 -->
            <el-button size="mini" type="text">分配权限</el-button>
            <el-button size="mini" type="text" @click="btnEditRow(row)">编辑</el-button>
            <el-button size="mini" type="text">删除</el-button>
        </template>
    </template>
</el-table-column>
```

> $set的应用

- this.$set(目标对象, 属性名称, 初始值 ) 
- 等价于 Vue.set(目标对象, 属性名称, 初始值)
- 向响应式对象中添加一个属性，并确保这个新属性同样是响应式的，且触发视图更新。

### 行内编辑-数据缓存

> 为什么要做数据缓存？

答： 因为编辑时，可以取消会滚到之前的状态，所以编辑时的数据是临时的数据。

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677753910169-3091b434-bb01-48f0-9fb1-59c027c01fb2.png#averageHue=%23f8f8f8&clientId=u437893ff-a4ad-4&from=paste&height=341&id=ue432bda9&name=image.png&originHeight=681&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3493115&status=done&style=none&taskId=uecfa0ac6-3c20-4b5d-98cd-7f4085284c4&title=&width=640)
如图，editRow的数据是针对当前行的数据做了一份拷贝，针对这个拷贝，我们可以随意修改。

- 初始化时缓存数据-代码位置(**src/views/role/index.vue**)

```javascript
    this.list.forEach(item => {
        // item.isEdit = false // 添加一个属性 初始值为false
        // 数据响应式的问题  数据变化 视图更新
        // 添加的动态属性 不具备响应式特点
        // this.$set(目标对象, 属性名称, 初始值) 可以针对目标对象 添加的属性 添加响应式
        this.$set(item, 'isEdit', false)
        this.$set(item, 'editRow', {
          name: item.name,
          state: item.state,
          description: item.description
        })
  })

```

- 点击编辑时更新缓存数据-代码位置(**src/views/role/index.vue**)

```javascript
btnEditRow(row) {
      row.isEdit = true // 改变行的编辑状态
      // 更新缓存数据
      row.editRow.name = row.name
      row.editRow.state = row.state
      row.editRow.description = row.description
}
```

- 将编辑时的表单双向绑定缓存数据-代码位置(**src/views/role/index.vue**)

```html
        <el-table-column prop="name" align="center" width="200" label="角色">
          <template v-slot="{ row }">
            <!-- 条件判断 -->
            <el-input v-if="row.isEdit" v-model="row.editRow.name" size="mini" />
            <span v-else>{{ row.name }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="state" align="center" width="200" label="启用">
          <!-- 自定义列结构 -->
          <template v-slot="{ row }">
            <!-- 开 1 关 0 -->
            <el-switch v-if="row.isEdit" v-model="row.editRow.state" :active-value="1" :inactive-value="0" />
            <span v-else>  {{ row.state === 1 ? "已启用" : row.state === 0 ? "未启用" : "无" }} </span>
          </template>
        </el-table-column>
        <el-table-column prop="description" align="center" label="描述">
          <template v-slot="{ row }">
            <el-input v-if="row.isEdit" v-model="row.editRow.description" size="mini" type="textarea" />
            <span v-else>{{ row.description }}</span>
          </template>
        </el-table-column>
```





# 员工管理

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677816490770-ee9d2bce-f4b5-40b9-a575-1a255231ae19.png#averageHue=%23fefefe&clientId=u37856cab-f36d-4&from=paste&height=341&id=ue79a6a55&name=image.png&originHeight=681&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3493115&status=done&style=none&taskId=u67e085fb-dc9c-4f94-8c13-d96d614062c&title=&width=640)





**选中首个节点**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677816999813-cd851a56-56ea-4380-a859-a4eaa9708b3a.png#averageHue=%23f5f8ef&clientId=u37856cab-f36d-4&from=paste&height=152&id=u769a010b&name=image.png&originHeight=304&originWidth=1510&originalType=binary&ratio=2&rotation=0&showTitle=false&size=40889&status=done&style=none&taskId=u5689e306-11d9-491a-9c7a-f8f97239ad5&title=&width=755)

**获取员工数据**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677826089100-e3f11e19-6d18-4fec-9ad5-e746c947887a.png#averageHue=%23fefefe&clientId=u37856cab-f36d-4&from=paste&height=165&id=u518b2953&name=image.png&originHeight=330&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1692741&status=done&style=none&taskId=u5c1030a2-debc-41d5-ac1b-f7eae5402a6&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677826096399-05624c46-2979-423c-85ba-4452b679cb10.png#averageHue=%23fdfdfd&clientId=u37856cab-f36d-4&from=paste&height=166&id=u4dce478c&name=image.png&originHeight=332&originWidth=772&originalType=binary&ratio=2&rotation=0&showTitle=false&size=26176&status=done&style=none&taskId=ue93bd7f0-3e3d-45ed-a796-5ff8c370f3c&title=&width=386)





**员工分页处理**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677827702383-06c2c5cb-4c7f-4ab1-bfe5-0406095796b8.png#averageHue=%23fefefe&clientId=u37856cab-f36d-4&from=paste&height=69&id=u1b12ccbc&name=image.png&originHeight=225&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1154164&status=done&style=none&taskId=uc4c8e202-39a4-4009-9246-3c8d936ef81&title=&width=394)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677827714376-1d8178bb-2cb2-43a3-b713-1675009e4d2c.png#averageHue=%23ecf2df&clientId=u37856cab-f36d-4&from=paste&height=211&id=u204b8e07&name=image.png&originHeight=422&originWidth=1236&originalType=binary&ratio=2&rotation=0&showTitle=false&size=53481&status=done&style=none&taskId=u9ed84bc8-d2b6-4c0d-b2b2-a2af88d8ace&title=&width=618)

### 员工的防抖查询

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828020009-c760b866-5375-4d0c-8f23-11aa5d1fe065.png#averageHue=%23fefefe&clientId=u37856cab-f36d-4&from=paste&height=198&id=u00f56db5&name=image.png&originHeight=396&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2031269&status=done&style=none&taskId=u74be04ed-1f6a-403c-bcb2-a96c0f6ca08&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828027949-0da76fe9-e36b-487c-893e-90ff008b4b24.png#averageHue=%23fdfdfd&clientId=u37856cab-f36d-4&from=paste&height=152&id=ufc4872ac&name=image.png&originHeight=304&originWidth=886&originalType=binary&ratio=2&rotation=0&showTitle=false&size=24172&status=done&style=none&taskId=uf0905b22-f703-49d8-8a58-addcd1278c3&title=&width=443)

- 设置模糊搜索的参数字段

```javascript
data () {
  return {
    queryParams: {
        departmentId: null,
        page: 1, // 当前页码
        pagesize: 10,
        keyword: '' // 模糊搜索字段
      },
  }
}
```

- 双向绑定input输入框，监听值改变事件

```html
<el-input
          v-model="queryParams.keyword"
          style="margin-bottom:10px"
          type="text"
          prefix-icon="el-icon-search"
          size="small"
          placeholder="输入员工姓名全员搜索"
          @input="changeValue"
/>
```

> 这里监听的事件是input，有同学可能会问，为什么不用change事件，注意change事件是离开焦点触发，input是只要内容发生变化就会触发，所以这里使用input更符合使用场景

- 值改变查询数据-支持防抖查询

```js
// 输入值内容改变时触发
changeValue() {
      // 单位时间内只执行最后一次
      // this的实例上赋值了一个timer的属性
      clearTimeout(this.timer) // 清理上一次的定时器
      this.timer = setTimeout(() => {
        this.queryParams.page = 1  // 页码改为1
        this.getEmployeeList()     // 获取员工列表
      }, 300)
}

// 第一次进入 changeValue 清理定时器，没得清理。正常去开启定时器，300ms后去执行
// 这个时候迅速的输入，定时器还没结束的时候呢又进来了这个changeValue
// 这个时候 timer 有值，就把它给清掉了。说明把刚刚做的定时器给清除掉了
// 之后呢，又开了一个定时器，这个时候不再去输入了，就会等到300ms结束之后去执行这个逻辑了
// 降低访问频率 单位时间内只执行最后一次 防抖
```



### 导出excel

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828319753-31bcffaf-2a61-4267-ae24-00941106fe4e.png#averageHue=%23e5deef&clientId=u1e237bb2-9603-4&from=paste&height=92&id=uc1d3da70&name=image.png&originHeight=242&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1241363&status=done&style=none&taskId=u2062e4e2-b90b-4c00-b546-2c46133a705&title=&width=487)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828330545-ab121cdb-4746-4352-aa84-0e3b35149d5e.png#averageHue=%23c3d9eb&clientId=u1e237bb2-9603-4&from=paste&height=76&id=u4c19b094&name=image.png&originHeight=152&originWidth=1100&originalType=binary&ratio=2&rotation=0&showTitle=false&size=21421&status=done&style=none&taskId=u6f61d557-53e9-45dc-acc0-59df84ba7c7&title=&width=550)

- 导出员工接口返回的是二进制流
- `axios`配置`responseType`为`blob`接收二进制流文件为Blob格式
- 安装`file-saver`包，实现下载Blob文件  `yarn add file-saver`

- 封装导出员工excel的API

```javascript
/**
 * 导出员工的excel
 * **/

export function exportEmployee() {
  return request({
    url: '/sys/user/export',
    // 改变接收数据的类型
    responseType: 'blob' // 使用blob接收二进制文件流
  })
}
```

- 拦截器判断是不是blob类型，如果是直接返回数据，不再进行解构-代码位置(**src/utils/request.js**)

```javascript
// 响应拦截器
service.interceptors.response.use((response) => {
  // axios默认包裹了data
  // 判断是不是Blob
  if (response.data instanceof Blob) return response.data // 返回了Blob对象
    
  const { data, message, success } = response.data // 默认json格式
  if (success) {
    return data
  } else {
    Message({ type: 'error', message })
    return Promise.reject(new Error(message))
  }
},
```


- 安装file-saver

```bash
$ npm i file-saver
$ yarn add file-saver
```

- 点击按钮调用接口，使用file-saver将blob转化成文件下载-代码位置(**src/views/employee/index.vue**)

```javascript
<el-button size="mini" @click="exportEmployee">excel导出</el-button>

 import FileSaver from 'file-saver'
 import { exportEmployee } from '@/api/employee'

  async  exportEmployee() {
      const result = await exportEmployee() // 导出所有的员工接口
      // console.log(result) // 使用一个npm包 直接将blob文件下载到本地 file-saver
      // FileSaver.saveAs(blob对象,文件名称)    什么格式都可以~
      FileSaver.saveAs(result, '员工信息表.xlsx') // 下载文件  
 }
```

### excel组件封装

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828812770-b9e9a610-169f-48bf-875e-d9c63ed6187e.png#averageHue=%23fcfcfc&clientId=u1e237bb2-9603-4&from=paste&height=360&id=u9bc36810&name=image.png&originHeight=720&originWidth=998&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2879691&status=done&style=none&taskId=ub5492142-a24b-42ff-bf59-be522824230&title=&width=499)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677828819899-364cd3ae-488b-4211-a194-f00032c4ca42.png#averageHue=%23fcfcfc&clientId=u1e237bb2-9603-4&from=paste&height=143&id=u267cb8bb&name=image.png&originHeight=286&originWidth=1534&originalType=binary&ratio=2&rotation=0&showTitle=false&size=51173&status=done&style=none&taskId=uabb6f6d5-a5c3-441c-ae67-0f061bff0f2&title=&width=767)

- 封装员工导入组件

```html
<template>
  <el-dialog
    width="500px"
    title="员工导入"
    :visible="showExcelDialog"
    @close="$emit('update:showExcelDialog', false)"
  >
    <el-row type="flex" justify="center">
      <div class="upload-excel">
        <input
          ref="excel-upload-input"    //  this.$refs['excel-upload-input'] 获取
          class="excel-upload-input"
          type="file"
          accept=".xlsx, .xls"        // 只接收excel文件
        >
        <div class="drop">
          <i class="el-icon-upload" />
          <el-button type="text">下载导入模板</el-button>
          <span>将文件拖到此处或
            <el-button type="text">点击上传</el-button>
          </span>
        </div>
      </div>
    </el-row>
    <el-row type="flex" justify="end">
      <!-- update:props属性名，值 直接修改 .sync修饰符的属性值 -->
      <el-button size="mini" type="primary" @click="$emit('update:showExcelDialog', false)">取消</el-button>
    </el-row>
  </el-dialog>
</template>
<script>

export default {
  props: {
      // 接收一个属性控制弹层的显示与否
    showExcelDialog: {
      type: Boolean,
      default: false
    }
  },
  methods: {

  }
}
</script>

<style scoped lang="scss">
    .upload-excel {
      display: flex;
      justify-content: center;
      margin: 20px;
      width: 360px;
      height: 180px;
      align-items: center;
      color: #697086;
      .excel-upload-input {
        display: none;
        z-index: -9999;
      }
      .btn-upload,
      .drop {
        border: 1px dashed #dcdfe6;
        width: 100%;
        height: 100%;
        text-align: center;
        line-height: 160px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .drop {
        line-height: 40px;
        color: #bbb;
        i {
          font-size: 60px;
          display: block;
          color: #c0c4cc;
        }
      }
    }
</style>
```

- 在员工管理页面-导入该组件并注册使用

```javascript
import ImportExcel from './components/import-excel.vue'

export default {
  components: {
    ImportExcel
  }
}
}
```

- 声明一个控制该弹层的变量

```javascript
data () {
  return  {
      showExcelDialog: false // 控制excel的弹层显示和隐藏
  }
}
```

- 使用该组件，并且应用变量-

```html
    <import-excel :show-excel-dialog.sync="showExcelDialog" />

```

- 点击员工导入弹出层

```html
 <el-button size="mini" @click="showExcelDialog = true">excel导入</el-button>
```



### 下载导入模板

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677829153067-cc9f9119-fd81-4451-b5f8-9bde624873ed.png#averageHue=%23fefefe&clientId=u1e237bb2-9603-4&from=paste&height=217&id=uae695f2f&name=image.png&originHeight=720&originWidth=925&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2669109&status=done&style=none&taskId=ud401a925-90e3-404f-8ca4-ffd3323492d&title=&width=278.5)![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677829173910-e6cee8ba-7daf-4edf-9329-a4ed20861aa5.png#averageHue=%23cbdeed&clientId=u1e237bb2-9603-4&from=paste&height=84&id=ucb62a407&name=image.png&originHeight=168&originWidth=1132&originalType=binary&ratio=2&rotation=0&showTitle=false&size=22361&status=done&style=none&taskId=u25492fba-9271-4bb2-ba48-2331535b3ca&title=&width=566)

- 封装下载模板的API

```javascript
/**
 * 下载员工导入模版
 * **/

export function getExportTemplate() {
  return request({
    url: '/sys/user/import/template',
    responseType: 'blob' // 二进制文件流
  })
}

```

- 点击按钮进行下载模板

```javascript
<el-button type="text" @click="getTemplate">下载导入模板</el-button>

async getTemplate() {
    const data = await getExportTemplate()
    FileSaver.saveAs(data, '员工导入模版.xlsx')
 }

```



### 员工导入-上传excel

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677829341053-f23b778f-3c92-4006-b61d-911acbcc3b3d.png#averageHue=%23fefefe&clientId=u1e237bb2-9603-4&from=paste&height=207&id=u078a50f7&name=image.png&originHeight=720&originWidth=934&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2695070&status=done&style=none&taskId=ua071a0fa-743f-4d4d-8a0a-f210132158b&title=&width=269)

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677829369801-572567fc-d90f-45ac-b98e-b24004490f96.png#averageHue=%23fcfcfc&clientId=u1e237bb2-9603-4&from=paste&height=141&id=u20edb1a6&name=image.png&originHeight=282&originWidth=1562&originalType=binary&ratio=2&rotation=0&showTitle=false&size=52252&status=done&style=none&taskId=u00c29fc3-cd91-4fb0-b5ce-2f4e20ab27f&title=&width=781)

- 封装上传excel的API

```javascript
/**
 * 上传用户的excel
 *
*/
export function uploadExcel(data) {
  return request({
    url: '/sys/user/import',
    method: 'post',
    data // form-data类型 因为要上传文件类型
  })
}
```

- 点击上传-弹出文件选择框

```javascript
<el-button type="text" @click="handleUpload">点击上传</el-button>

handleUpload() {
      this.$refs['excel-upload-input'].click() // this.$refs.属性名 和 this.$refs[属性名] 等价
},
```

- 监听文件改变-上传excel-关闭弹层

```javascript
 <input
          ref="excel-upload-input"
          class="excel-upload-input"
          type="file"
          accept=".xlsx, .xls"
          @change="uploadChange"
  >
              
  async uploadChange(event) {
      console.log(event.target.files)  // 拿到文件列表
      // 调用上传接口
      // uploadExcel() // 参数  form-data 需要文件file
      const files = event.target.files // input的文件列表
      if (files.length > 0) {
        // 大于0 说明有文件要上传
        const data = new FormData()
        // file: file类型
        data.append('file', files[0]) // 将文件参数加入到formData中
        try {
          await uploadExcel(data)
          // 成功
          this.$emit('uploadSuccess') // 通知父组件 我上传成功 重新加载员工列表
          this.$emit('update:showExcelDialog', false) // 关闭弹层
          // this.$refs['excel-upload-input'].value = ''
        } catch (error) {
          // 捕获失败  清空文件选择器
          // this.$refs['excel-upload-input'].value = ''
        } finally {
          // 不论成功或者失败都会执行finally
          this.$refs['excel-upload-input'].value = ''
        }
      }
}
```

> 这里为什么不管成功或者失败都要清空文件选择器中的内容呢？ 因为不论成功或者失败，再点击上传都会去选择一个新的excel，所以这里使用finally等到最后，将内容清空。

- 父组件需要监听上传成功的事件-代码位置(**src/views/employee/index.vue**)

```html
<import-excel :show-excel-dialog.sync="showExcelDialog" @uploadSuccess="getEmployeeList" />

// getEmployeeList 获取员工列表的方法 有了
```





# 员工详情-cos上传

### 封装部门级联组件

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677830958823-382c48a4-3758-4a38-a81e-1cad5055ab56.png#averageHue=%23fefefe&clientId=u1e237bb2-9603-4&from=paste&height=295&id=uad0fc54d&name=image.png&originHeight=589&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3021229&status=done&style=none&taskId=ub0892135-f60d-4f7e-adc6-69d9879fb94&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677830967822-96b40509-bbcb-4892-bade-bfe1c76a82ed.png#averageHue=%23c5daec&clientId=u1e237bb2-9603-4&from=paste&height=181&id=udb159183&name=image.png&originHeight=362&originWidth=798&originalType=binary&ratio=2&rotation=0&showTitle=false&size=33059&status=done&style=none&taskId=ue715dad5-3d63-41f0-a625-03dd1ddb5bb&title=&width=399)

**Cascader级联组件的特性**

1. options为一个树形结构的数据源
2. props可以设置数据源中的字段如 label (展示)  value（存取）
3. separator为展示的分隔符

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677831436880-afdcff2a-8901-4008-9304-0f41e4fc58c3.png#averageHue=%23202020&clientId=u1e237bb2-9603-4&from=paste&height=128&id=u8fac2217&name=image.png&originHeight=644&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3303332&status=done&style=none&taskId=ue7bfa337-4ae8-43ad-8f4b-63357b427c8&title=&width=254)![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677831446397-5c5fa77f-ba2d-47c7-a8d3-255d6eda4ebb.png#averageHue=%23222120&clientId=u1e237bb2-9603-4&from=paste&height=130&id=uf76ade42&name=image.png&originHeight=697&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3575181&status=done&style=none&taskId=u3a80d5f4-69b9-4337-b38e-7aef64aacf5&title=&width=238)


- 创建select-tree组件

```vue
<template>
  <!-- element-ui级联组件 -->
  <el-cascader
    size="mini"
    :options="treeData" // 绑定要显示的数组
    :props="props"   
    separator="-"
  />
</template>
<script>
import { getDepartment } from '@/api/department'
import { transListToTreeData } from '@/utils'
export default {
  data() {
    return {
      treeData: [], // 赋值给 级联组件的options
      props: {
        label: 'name', // 要展示的字段
        value: 'id' // 要存储的字段
      }
    }
  },
  created() {
    this.getDepartment()
  },
  methods: {
    async getDepartment() {
      this.treeData = transListToTreeData(await getDepartment(), 0) // 将组织架构的数据 转化树形赋值给treeData
    }
  }
}
</script>
```

- 解决转化树形中的问题

```javascript
/**
 *
 * 列表型数据转化树形
*/

export function transListToTreeData(list, rootValue) {
  const arr = []
  list.forEach(item => {
    if (item.pid === rootValue) {
      // 找到了匹配的节点
      arr.push(item)
      // 当前节点的id 和 当前节点的子节点的pid是想等的
      const children = transListToTreeData(list, item.id) // 找到的节点的子节点
      if (children.length) { item.children = children } // 将子节点赋值给当前节点
    }
  })
  return arr
}
```

> 这里我们加了一个判断，就是只有当前节点有子节点时才添加children属性，否则会造成级联组件本身就已经是最末端了，但是发现它的children属性存在，就会呈现不同的表现形式。

- 使用select-tree组件

> 不要忘记引入注册

```html
<el-form-item label="部门" prop="departmentId">
      <!-- 放置及联部门组件 会单独封装-->
      <!-- inputW样式会给到selectTree中 template第一层的组件 -->
      <select-tree class="inputW" />
</el-form-item>
```



**级联组件-双向绑定**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677831500136-e6c90091-aa4a-485d-a564-769f3e421c98.png#averageHue=%23222120&clientId=u1e237bb2-9603-4&from=paste&height=106&id=u397f690a&name=image.png&originHeight=239&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1225976&status=done&style=none&taskId=u2cf97501-2701-40db-89be-981ae38af4e&title=&width=569)

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677831496148-6c0291f7-2ec7-4821-9211-e9ab7ddfe5e2.png#averageHue=%23c4d9ec&clientId=u1e237bb2-9603-4&from=paste&height=149&id=ue8fd4fa3&name=image.png&originHeight=298&originWidth=1170&originalType=binary&ratio=2&rotation=0&showTitle=false&size=36509&status=done&style=none&taskId=u7953b151-cc26-4746-832b-66b4364b54e&title=&width=585)

- 接收value属性-

```js
export default {
  props: {
    value: {
      type: Number, // 存储的是部门的id  3 4 5
      default: null
    }
  }
}
```

- 级联改变触发input事件

```javascript
 <el-cascader
    :value="value"
    size="mini"
    :options="treeData"
    :props="props"
    separator="-"
    @change="changeValue"
  />
// 值改变的时候触发事件
 changeValue(list) {
      // 取到数组的最后一次
      if (list.length > 0) {
        this.$emit('input', list[list.length - 1]) // 将最后一位的id取出来 传出去
      } else {
        this.$emit('input', null) // 如果长度为0 说明值为空
      }
}
```

- 在父组件使用v-model双向绑定-

```html
<select-tree v-model="userInfo.departmentId" class="inputW" />

```





### 封装员工头像组件

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833005395-f17c7423-3376-4c00-96d1-67c3167f7412.png#averageHue=%23fbfcfd&clientId=u4c56d459-399b-4&from=paste&height=194&id=u17995a34&name=image.png&originHeight=720&originWidth=1160&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3346993&status=done&style=none&taskId=udfc1e3ab-ddcf-4bbf-8fa5-c0b08a8e16b&title=&width=313)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833020435-9b0d3283-7792-4052-b334-e71b9aad9428.png#averageHue=%2386b42d&clientId=u4c56d459-399b-4&from=paste&height=126&id=ubd9721b3&name=image.png&originHeight=252&originWidth=1580&originalType=binary&ratio=2&rotation=0&showTitle=false&size=50936&status=done&style=none&taskId=u1e41f982-65ec-4541-a46e-27912e313d7&title=&width=790)

- 封装image-upload组件

```vue
<template>
  <el-upload
    class="avatar-uploader"
    action=""
    :show-file-list="false"
    :before-upload="beforeAvatarUpload"  // 上传前检查
  >
    <!-- (自动上传)action是上传地址 人资项目不需要 人资项目(手动上传)  -->
    <!-- show-file-list不展示列表 -->
    <img v-if="value" :src="value" class="avatar">
    <i v-else class="el-icon-plus avatar-uploader-icon" />
  </el-upload>
</template>

<script>
export default {
  props: {
    value: {
      type: String,
      default: ''
    }
  },
  methods: {
    // 检查函数 判断文件的类型还有大小 return  true(继续上传)/false(停止上传)
    beforeAvatarUpload(file) {
      // jpeg png gif bmp

      const isJPG = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp'].includes(file.type)
      const isLt2M = file.size / 1024 / 1024 < 5 // 5M

      if (!isJPG) {
        this.$message.error('上传头像图片只能是 JPG PNG GIF BMP 格式!')
      }
      if (!isLt2M) {
        this.$message.error('上传头像图片大小不能超过 5MB!')
      }
      return isJPG && isLt2M
    }
  }
}
</script>

<style>
  .avatar-uploader .el-upload {
    border: 1px dashed #d9d9d9;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .avatar-uploader .el-upload:hover {
    border-color: #409EFF;
  }
  .avatar-uploader-icon {
    font-size: 28px;
    color: #8c939d;
    width: 178px;
    height: 178px;
    line-height: 178px;
    text-align: center;
  }
  .avatar {
    width: 178px;
    height: 178px;
    display: block;
  }
</style>
```

- 在父组件中应用-代码位置(**src/views/employee/detail.vue**)

```html
  <image-upload v-model="userInfo.staffPhoto" />
```



### 创建腾讯云存储桶

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833258270-eee271c3-5ab1-4484-9c0f-97f6817af64f.png#averageHue=%23c3d9ec&clientId=u4c56d459-399b-4&from=paste&height=92&id=u68c58fd9&name=image.png&originHeight=184&originWidth=1670&originalType=binary&ratio=2&rotation=0&showTitle=false&size=29580&status=done&style=none&taskId=ua8153662-e6bb-479d-8269-62be9e760b7&title=&width=835)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833270507-5fc631dc-8bc0-427b-b6fc-6731d5d8960e.png#averageHue=%23e8e4dc&clientId=u4c56d459-399b-4&from=paste&height=187&id=u6cd76483&name=image.png&originHeight=374&originWidth=1476&originalType=binary&ratio=2&rotation=0&showTitle=false&size=126500&status=done&style=none&taskId=uadca734a-ec8b-48e9-8239-d5f2e2c92f6&title=&width=738)
1.注册腾讯云账号-课前完成[https://cloud.tencent.com/login](https://cloud.tencent.com/login)  
2.创建腾讯云存储桶
3.得到应用密钥和应用标识

- 创建存储桶

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833319333-ada7a14d-3dc2-449d-a9c9-5b5fb00d9fe3.png#averageHue=%231c1f28&clientId=u4c56d459-399b-4&from=paste&height=264&id=ue3bf684f&name=image.png&originHeight=720&originWidth=1272&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3670083&status=done&style=none&taskId=u27544305-f443-4d08-9e41-513a836530c&title=&width=466)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833333438-7867e505-14c6-4abf-b61a-23f8a370e1c8.png#averageHue=%23fafafa&clientId=u4c56d459-399b-4&from=paste&height=317&id=u7d26f2f4&name=image.png&originHeight=720&originWidth=1049&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3026800&status=done&style=none&taskId=u51b093b7-d9c7-42ce-9016-70c4c9c8ede&title=&width=462.5)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833344558-6f548828-6a72-464f-8a67-60d1ace6efa7.png#averageHue=%23fbf3ee&clientId=u4c56d459-399b-4&from=paste&height=360&id=uc11ba825&name=image.png&originHeight=720&originWidth=1008&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2908532&status=done&style=none&taskId=u9199e9d8-739f-4fd2-bbb4-99691aeaf24&title=&width=504)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833350344-1a8b6f3c-cea8-4df0-a5aa-4dd7caf2ee3f.png#averageHue=%23fbfbfb&clientId=u4c56d459-399b-4&from=paste&height=360&id=u4648f900&name=image.png&originHeight=720&originWidth=844&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2435446&status=done&style=none&taskId=u356ae19d-7e0f-4aef-a833-be616db90b4&title=&width=422)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833354890-226ff7c8-0f51-4406-bc3a-adf30f6ffba1.png#averageHue=%23f4f4f4&clientId=u4c56d459-399b-4&from=paste&height=349&id=u7601d039&name=image.png&originHeight=1280&originWidth=664&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3406539&status=done&style=none&taskId=uccfd9cff-e367-4399-842a-d5648dc33ef&title=&width=181)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833364446-1c41ff0e-4a99-4843-9ac8-e6196cd15b0d.png#averageHue=%23fafafa&clientId=u4c56d459-399b-4&from=paste&height=200&id=ud7178459&name=image.png&originHeight=540&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2769888&status=done&style=none&taskId=u704f0064-3b24-4b0b-b910-8e28d5a461c&title=&width=473)

**2.1获取存储桶相关信息**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833395741-421e5f68-e815-47cc-b3d6-f0259e75cd08.png#averageHue=%23f9f9f8&clientId=u4c56d459-399b-4&from=paste&height=188&id=u78bf5e6d&name=image.png&originHeight=568&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2913512&status=done&style=none&taskId=u2b3ca8ed-9418-4f37-9aea-b7c8e77bbba&title=&width=423)

> 将存储桶和所属地域拷贝下来，备用

- 获取应用标识[https://console.cloud.tencent.com/cam/capi](https://console.cloud.tencent.com/cam/capi)

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833458836-4629c1cf-32ab-4b6a-9b26-6a4862bc0299.png#averageHue=%23f9f9f9&clientId=u4c56d459-399b-4&from=paste&height=146&id=uf87d5b81&name=image.png&originHeight=291&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1492692&status=done&style=none&taskId=u31f9e329-b250-4b5c-ab7c-af26c19399b&title=&width=640)

> 将SecretId和SecretKey拷贝下来，备用



### 使用cos-sdk完成上传

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833552518-92362551-cb15-481b-82a7-8d1430938cda.png#averageHue=%23caddee&clientId=u4c56d459-399b-4&from=paste&height=89&id=u1ca7c711&name=image.png&originHeight=214&originWidth=1634&originalType=binary&ratio=2&rotation=0&showTitle=false&size=29863&status=done&style=none&taskId=u71fec65b-680e-4615-9412-1cce1f412af&title=&width=683)

- 安装腾讯云js-sdk

```bash
$ npm i cos-js-sdk-v5 
$ yarn add  cos-js-sdk-v5

```

- 使用el-upload自定义上传-代码位置

```html
<template>
  <el-upload
    class="avatar-uploader"
    action=""
    :show-file-list="false"
    :before-upload="beforeAvatarUpload"
    :http-request="uploadImage"  // 选择图片的时候上传
  >
    <!-- (自动上传)action是上传地址 人资项目不需要 人资项目(手动上传)  -->
    <!-- show-file-list不展示列表 -->
    <img v-if="value" :src="value" class="avatar">
    <i v-else class="el-icon-plus avatar-uploader-icon" />
  </el-upload>
</template>

```

- 实现上传方法-代码位置

```javascript
    // 选择图片上传
    uploadImage(params) {
      // console.log(params.file)  要上传的文件
      const cos = new COS({
        SecretId: 'AKIDDSdjgnjT1NZ3a7VjkfVIwOdfv9IH2b8e',
        SecretKey: 'WEwe9WJ9vLeq1BHNLLKF5Up10ndUDk24'
      }) // 完成cos对象的初始化
      cos.putObject({
        Bucket: 'heimachengxuyuan-1302806742', // 存储桶名称
        Region: 'ap-nanjing', // 地域名称
        Key: params.file.name, // 文件名称
        StorageClass: 'STANDARD', // 固定值
        Body: params.file // 文件对象
      }, (err, data) => {
        if (data.statusCode === 200 && data.Location) {
          // 拿到了腾讯云返回的地址
          // 通过input自定义事件将地址传出去
          this.$emit('input', 'http://' + data.Location) // 将地址返回了
        } else {
          this.$message.error(err.Message) // 上传失败提示消息
        }
      })
    }
```

> 这里需要使用 上个小节准备好的存储桶的名称-地域名称-应用标识-应用密钥


这里需要知道Cos的初始化和上传的方法
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833817089-4f668b24-9c77-4cac-912f-ffdbaf6af09e.png#averageHue=%23f4f4e5&clientId=u4c56d459-399b-4&from=paste&height=150&id=ua0daf110&name=image.png&originHeight=300&originWidth=954&originalType=binary&ratio=2&rotation=0&showTitle=false&size=32482&status=done&style=none&taskId=u7c39a9e6-b10c-4c13-89ec-74e21670494&title=&width=477)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833842743-a46c4235-2b40-4664-93f8-a826709b6d93.png#averageHue=%23f9f9dc&clientId=u4c56d459-399b-4&from=paste&height=179&id=ue9b81845&name=image.png&originHeight=358&originWidth=900&originalType=binary&ratio=2&rotation=0&showTitle=false&size=63540&status=done&style=none&taskId=uc722b42c-a51b-4aa7-b405-2e1228f4c62&title=&width=450)





# 权限管理

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677833885187-f484a9b4-ade0-47c0-b720-12b2a3c01c5a.png#averageHue=%23fefefe&clientId=u4c56d459-399b-4&from=paste&height=303&id=u66c40e4b&name=image.png&originHeight=605&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3103295&status=done&style=none&taskId=u736dae85-0d0e-4793-a6b6-b7146ef59a3&title=&width=640)



### 权限概念

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834304319-dbfd8faf-bd57-4719-8450-4c03a656e4be.png#averageHue=%23b6d0e7&clientId=u4c56d459-399b-4&from=paste&height=182&id=ufe5f4cac&name=image.png&originHeight=364&originWidth=1238&originalType=binary&ratio=2&rotation=0&showTitle=false&size=42816&status=done&style=none&taskId=ud740de6a-bee8-4e87-88b5-86e225e698a&title=&width=619)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834314017-e9d78635-e9d8-44e9-93f7-42b81a27aa8e.png#averageHue=%23fdfdfd&clientId=u4c56d459-399b-4&from=paste&height=158&id=u34e536b5&name=image.png&originHeight=316&originWidth=1124&originalType=binary&ratio=2&rotation=0&showTitle=false&size=22602&status=done&style=none&taskId=u31de76fa-a41e-4bdc-ac7a-b55b841527f&title=&width=562)

> 权限是通过角色这个中间人实现，首先员工拥有角色，角色拥有权限，那么员工自动拥有了角色所对应的权限。

所以接下来，我们需要实现 给员工分配角色，给角色分配权限。

- 分配过程-给员工分角色

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834416868-5e31e01e-e5e9-4261-ab5d-04dcc35a6165.png#averageHue=%23d0d0d0&clientId=u4c56d459-399b-4&from=paste&height=180&id=u054c55cf&name=image.png&originHeight=360&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1846624&status=done&style=none&taskId=ub98ea7a2-374d-4b01-97a3-54e4933434c&title=&width=640)

- 分配过程-给角色分权限

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834426135-cbfcb3d8-6fff-403a-b971-fdef39077f65.png#averageHue=%23e4e4e4&clientId=u4c56d459-399b-4&from=paste&height=360&id=u3440f90d&name=image.png&originHeight=720&originWidth=1132&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3266235&status=done&style=none&taskId=u7bb220a2-e649-460c-8966-5c0a857a505&title=&width=566)



### 员工分配角色

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834466527-d20cd145-69c2-46ad-9dcc-c833f0403268.png#averageHue=%23fefefe&clientId=u4c56d459-399b-4&from=paste&height=67&id=u254cf4cd&name=image.png&originHeight=267&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1369588&status=done&style=none&taskId=ub2f6eb3d-3333-459c-aa62-cfe973041c9&title=&width=323)![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834477921-35954767-07b5-49d3-8ac8-f422128a5852.png#averageHue=%23fefefe&clientId=u4c56d459-399b-4&from=paste&height=96&id=ufba0eaa6&name=image.png&originHeight=350&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1795320&status=done&style=none&taskId=u3d3ef042-ff7f-4f54-8155-63e07094ccb&title=&width=351)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834495411-f054d3f5-19f1-4c2f-ad2a-b774c4f36e54.png#averageHue=%23b5d0e7&clientId=u4c56d459-399b-4&from=paste&height=67&id=u44db7def&name=image.png&originHeight=134&originWidth=1014&originalType=binary&ratio=2&rotation=0&showTitle=false&size=14655&status=done&style=none&taskId=ub20aa228-1fe7-45b2-b7eb-344b31296db&title=&width=507)

- 封装获取可用角色的API

```javascript
// 获取可用的角色
export function getEnableRoleList() {
  return request({
    url: '/sys/role/list/enabled'
  })
}
```

- 声明变量控制弹层显示-和角色列表

```javascript
data () {
  return {
      showRoleDialog: false, // 用来控制角色弹层的显示
      roleList: [], // 接收角色列表
      roleIds: [] // 用来双向绑定数据的
  }
}
```

- 点击角色按钮-获取角色列表

```javascript
// 点击角色按钮弹出层
    async btnRole() {
      this.showRoleDialog = true
      this.roleList = await getEnableRoleList()
    }
```

- 放置弹层-绑定变量和渲染checkbox

```html
<el-dialog :visible.sync="showRoleDialog" title="分配角色">
      <!-- 弹层内容 -->
      <el-checkbox-group v-model="roleIds">
        <!-- 放置n个的checkbox  要指定checkbox的存储值:label item.id-->
        <el-checkbox v-for="item in roleList" :key="item.id" :label="item.id">{{ item.name }}</el-checkbox>
     </el-checkbox-group>
</el-dialog>
```

**回显数据并提交**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677834822261-0ccc70cf-1091-4922-ba62-0b06815fad6f.png#averageHue=%2387b52e&clientId=u4c56d459-399b-4&from=paste&height=184&id=u3b177e32&name=image.png&originHeight=368&originWidth=1556&originalType=binary&ratio=2&rotation=0&showTitle=false&size=52739&status=done&style=none&taskId=u878da963-daa2-42c7-b04f-72662d6ad2f&title=&width=778)

- 封装给员工分配角色的接口

```javascript
// 分配员工角色
export function assignRole(data) {
  return request({
    url: '/sys/user/assignRoles',
    method: 'put',
    data
  })
}
```

- 点击角色按钮时，获取员工已经拥有的角色，并记录当前点击的用户id

  在data中声明一个id用来记录

```javascript
data () {
  return  {
    currentUserId: null // 用来记录当前点击的用户id
  }
}
```

```javascript
async btnRole(id) {
      this.roleList = await getEnableRoleList()
      // 记录当前点击的id 因为后边 确定取消要存取给对应的用户
      this.currentUserId = id
      // 获取用户拥有的角色 
      const { roleIds } = await getEmployeeDetail(id)
      this.roleIds = roleIds
      this.showRoleDialog = true // 调整顺序
},
```

> 注意，这里我们特地调整了弹层的顺序，因为获取已经拥有的角色是一个异步的过程，如果弹层显示在前，会出现卡顿的效果，表现出缓慢的效果，所以等到获取所有数据之后再弹层。

- 点击确定实现给用户分配角色

```javascript
 // 点击角色的确定
    async  btnRoleOK() {
      await assignRole({
        id: this.currentUserId,
        roleIds: this.roleIds
      })
      this.$message.success('分配用户角色成功')
      this.showRoleDialog = false
    }
```

- 取消关闭弹层

```html
<el-row slot="footer" type="flex" justify="center">
  <el-col :span="6">
    <el-button type="primary" size="mini" @click="btnRoleOK">确定</el-button>
    <el-button size="mini" @click="showRoleDialog = false">取消</el-button>
  </el-col>
</el-row>
```

### 给角色分配权限

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677835230908-40c17c33-b3d5-434c-a518-ea3ff24acf5c.png#averageHue=%23f4e3e9&clientId=u4c56d459-399b-4&from=paste&height=65&id=udc267641&name=image.png&originHeight=437&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2241577&status=done&style=none&taskId=uae0dfe4b-c231-4e08-830d-b8b7d30508b&title=&width=191)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677835321380-483e544d-32b4-4b48-81fb-ea5e677a0264.png#averageHue=%23d2e2f1&clientId=u4c56d459-399b-4&from=paste&height=194&id=ua855eb4f&name=image.png&originHeight=388&originWidth=912&originalType=binary&ratio=2&rotation=0&showTitle=false&size=26875&status=done&style=none&taskId=ue88be67e-a628-4cdd-87e9-1bbb396a924&title=&width=456)

- 声明变量控制弹层显示和接收权限数据

```javascript
data () {
  return {
     showPermissionDialog: false,
     permissionData: []
  }
}
```

- 点击分配权限-弹出层-获取数据并转化树形

```javascript
<el-button size="mini" type="text" @click="btnPermission">分配权限</el-button>

async  btnPermission() {
      this.showPermissionDialog = true
      this.permissionData = transListToTreeData(await getPermissionList(), 0)
}
```

- 放置弹层和树组件

```html
<!-- 放置权限弹层 -->
    <el-dialog :visible.sync="showPermissionDialog" title="分配权限">
      <!-- 放置权限数据 -->
      <el-tree
        :data="permissionData"  // 能显示结构看不见字段
        :props="{ label: 'name' }"  // 要展示的字段
        show-checkbox             // 节点是否可被选择
        default-expand-all
      />
    </el-dialog>
```

**显示已有权限数据**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677835574407-3f4ad4a4-65fd-4a0f-a2e8-074dabe043a1.png#averageHue=%23f4e3e9&clientId=u4c56d459-399b-4&from=paste&height=87&id=ua69ac3b1&name=image.png&originHeight=437&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2241577&status=done&style=none&taskId=u41cdbe97-7e2a-4b7e-818d-2cc09ff0764&title=&width=254)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677835588018-bba64874-f186-44e3-9f6f-18d2a14d4582.png#averageHue=%23eff4e5&clientId=u4c56d459-399b-4&from=paste&height=167&id=u1193adcc&name=image.png&originHeight=334&originWidth=1718&originalType=binary&ratio=2&rotation=0&showTitle=false&size=53471&status=done&style=none&taskId=u9f6c56be-f21b-47d6-90ba-831fe530144&title=&width=859)

- 封装获取角色详情的API

```javascript
// 获取角色详情
export function getRoleDetail(id) {
  return request({
    url: `/sys/role/${id}`
  })
}
```

- 声明变量记录当前点击的角色id和角色所拥有的权限数据

```javascript
data () {
  return {
      currentRoleId: null,  // 记录当前点击的角色 id
      permIds: []  // 角色所拥有的权限
  }
}
```

- 点击分配权限按钮时传递角色id，并根据id获取该角色所拥有的权限

```javascript
<el-button size="mini" type="text" @click="btnPermission(row.id)">分配权限</el-button>

async  btnPermission(id) {
      this.currentRoleId = id  // 记录id
      // 根据id获取该角色所拥有的权限
      const { permIds } = await getRoleDetail(id)
      this.permIds = permIds
    
      this.permissionData = transListToTreeData(await getPermissionList(), 0)
      this.showPermissionDialog = true
}
```

- 设置el-tree组件的属性-node-key和当前选中数据

```html
<el-tree
        ref="premTree"
        node-key="id" // 表示哪个字段是唯一的
        check-strictly   // 父子不互相关联
        :data="permissionData"
        :props="{ label: 'name' }"
        show-checkbox
        default-expand-all
         
        :default-checked-keys="permIds"  // 当前选中数据 
  />
```

> default-checked-keys的属性是设置当前选中的节点，但是必须配合node-key属性，因为permIds变量中存储的都是id，必须el-tree组件知道key是哪个字段，所以设置node-key="id"

**确定提交**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677836272564-462602b4-6059-4b73-9ffb-f6b13de8ab2d.png#averageHue=%23a5c7e2&clientId=u4c56d459-399b-4&from=paste&height=109&id=u6a76f137&name=image.png&originHeight=218&originWidth=984&originalType=binary&ratio=2&rotation=0&showTitle=false&size=25675&status=done&style=none&taskId=u32b777b0-4e91-4f53-9cb2-6e972d1c64d&title=&width=492)

- 封装分配权限的接口API

```javascript
// 给角色分配权限
export function assignPerm(data) {
  return request({
    url: '/sys/role/assignPrem',
    method: 'put',
    data
  })
}
```

- 确定和取消事件

```javascript
 <el-row slot="footer" type="flex" justify="center">
        <el-col :span="6">
          <el-button type="primary" size="mini" @click="btnPermissionOK">确定</el-button>
          <el-button size="mini" @click="showPermissionDialog = false">取消</el-button>
      </el-col>
  </el-row>

// 点击确定时触发
    async  btnPermissionOK() {
      await assignPerm({
        id: this.currentRoleId,
        permIds: this.$refs.permTree.getCheckedKeys()  // 选择目前被选中的节点
      })
      this.$message.success('角色分配权限成功')
      this.showPermissionDialog = false
    }
```



### 拆分静态路由-动态路由![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677837267385-362b4b13-53e2-4c5a-b340-8fa439bb0102.png#averageHue=%2387b52f&clientId=u7263e634-8cc4-4&from=paste&height=142&id=ue8c221fc&name=image.png&originHeight=284&originWidth=2104&originalType=binary&ratio=2&rotation=0&showTitle=false&size=65290&status=done&style=none&taskId=ubc162632-8ffc-4931-a6dd-b169dd1caa7&title=&width=1052)

- 将静态路由和动态路由进行拆分

```javascript
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'
import departmentRouter from './modules/department'
import approvalRouter from './modules/approval'
import attendanceRouter from './modules/attendance'
import employeeRouter from './modules/employee'
import permissionRouter from './modules/permission'
import roleRouter from './modules/role'
import salaryRouter from './modules/salary'
import socialRouter from './modules/social'

// 静态路由
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  },

  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

// 动态路由
export const asyncRoutes = [
  departmentRouter,
  roleRouter,
  employeeRouter,
  permissionRouter,
  attendanceRouter,
  approvalRouter,
  salaryRouter,
  socialRouter
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes // 默认引入静态路由
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router
```



### 根据用户权限添加动态路由

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677837731510-005dbaaa-416c-4c49-9f8b-113fb9a94dc0.png#averageHue=%23b6c3d8&clientId=u7263e634-8cc4-4&from=paste&height=77&id=ucc320e85&name=image.png&originHeight=154&originWidth=1902&originalType=binary&ratio=2&rotation=0&showTitle=false&size=41749&status=done&style=none&taskId=u6ef51489-2a69-4172-ad97-64fe4e08bb9&title=&width=951)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677837769508-38e7a1df-4f64-4a2b-8b6a-f235b906d385.png#averageHue=%23f3f2e3&clientId=u7263e634-8cc4-4&from=paste&height=221&id=u1e9e9009&name=image.png&originHeight=442&originWidth=1586&originalType=binary&ratio=2&rotation=0&showTitle=false&size=117596&status=done&style=none&taskId=u8b008797-782d-4f74-bd59-ade11a34dd3&title=&width=793)
怎么匹配?

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677837804419-cfcccd44-207b-48c6-9d82-4567c0d91e1d.png#averageHue=%23b7b1b0&clientId=u7263e634-8cc4-4&from=paste&height=193&id=ue8c001dc&name=image.png&originHeight=544&originWidth=1556&originalType=binary&ratio=2&rotation=0&showTitle=false&size=173238&status=done&style=none&taskId=u81c10b5d-52ce-48fc-8807-eb2cbfcfa2c&title=&width=552)


- Vuex用户模块action中返回result信息

```javascript
// 获取用户的基本资料
async getUserInfo(context) {
    const result = await getUserInfo()
    context.commit('setUserInfo', result)
    return result // 返回用户资料 返回给调用者
}
```

- 权限拦截处筛选-添加路由-

```javascript
// 引入动态路由
import { asyncRoutes } from '@/router'


/**
 *前置守卫
 *
*/
 
      // 判断是否获取过资料
      if (!store.getters.userId) {
        const { roles } = await store.dispatch('user/getUserInfo')
        // console.log(roles.menus) // 数组 里面存储着权限点标识
        // console.log(asyncRoutes) // 数组 8个动态路由
        // 给每一个动态路由加一个name标识，和roles.menus里的权限点标识去做对应
        // 每一个路由的 name 对应权限点的标识

        // 第二步筛选路由，不同的人有不同的路由权限
        const filterRoutes = asyncRoutes.filter(item => {
          // filter 返回  true/false
          // item.name 是每一个动态路由的名字标识name
          // 看看name在不在这个权限点标识里面，在就表示有这个路由权限，不在就没有权限
          // 如果包含就返回 true， 不包含返回false
          return roles.menus.includes(item.name)
        })
        // filterRoutes 就是筛选后的路由
        // console.log(filterRoutes) // 筛选出有权限的动态路由
        
        // 添加动态路由
        // 添加动态路由信息到路由表  解决出现404的问题
router.addRoutes([...filterRoutes, { path: '*', redirect: '/404', hidden: true }]) 
         

        // router添加动态路由之后 需要转发一下
        next(to.path) // 目的是让路由拥有信息 router的已知缺陷
      } else {
          
          next()
      }


      
          
          
          
          
          
```

- **删除静态路由中的404**

```javascript
/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  }
    // 404 必须放在最后 
    // 要放在所有路由的最后，添加的动态路由的后面
]
```

- 针对每个路由模块的配置文件添加name属性，和权限的数据进行对应。

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677841628970-275b0590-2bb5-4dfe-acf2-be0e27a8639a.png#averageHue=%2320201f&clientId=u7263e634-8cc4-4&from=paste&height=360&id=udf3c79a2&name=image.png&originHeight=720&originWidth=912&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2631609&status=done&style=none&taskId=u9fc3ac0d-3e77-40e8-8b5e-33dec9da53b&title=&width=456)



### 根据权限显示左侧菜单

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677841660021-7d71de2c-3efd-4fe4-8b9d-4c3604b27b7a.png#averageHue=%23b2c3da&clientId=u7263e634-8cc4-4&from=paste&height=74&id=ua420e34c&name=image.png&originHeight=148&originWidth=1956&originalType=binary&ratio=2&rotation=0&showTitle=false&size=42716&status=done&style=none&taskId=u06f15b91-6abe-4316-b814-2257fbbe792&title=&width=978)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677841668181-45ecf5df-9a74-4264-af59-1c97a855eb12.png#averageHue=%23c2d898&clientId=u7263e634-8cc4-4&from=paste&height=62&id=u369753b3&name=image.png&originHeight=124&originWidth=1946&originalType=binary&ratio=2&rotation=0&showTitle=false&size=40489&status=done&style=none&taskId=ub6f008d8-e7d0-41e6-965e-75aa1b70165&title=&width=973)

- Vuex中的user模块添加state管理

```javascript
import { getToken, setToken, removeToken } from '@/utils/auth'
import { login, getUserInfo } from '@/api/user'
// 引入静态路由
import { constantRoutes } from '@/router'/////////////////////////////////////1
const state = {
  token: getToken(), // 从缓存中读取初始值
  userInfo: {}, // 存储用户基本资料状态
  routes: constantRoutes // 静态路由的数组////////////////////////////////////2
}

const mutations = {
  setToken(state, token) {
    state.token = token
    // 同步到缓存
    setToken(token)
  },
  removeToken(state) {
    // 删除Vuex的token
    state.token = null
    removeToken()
  },
  setUserInfo(state, userInfo) {
    state.userInfo = userInfo
  },
    //////////////////////////////////////////////////////////////3
    // 更新 state 中的路由
  setRoutes(state, newRoutes) {
    state.routes = [...constantRoutes, ...newRoutes] // 静态路由 + 动态路由
  }
}
```

- 筛选路由后，更新state信息

```javascript
import router from '@/router'
import nprogress from 'nprogress'
import 'nprogress/nprogress.css'
import store from '@/store'
import { asyncRoutes } from '@/router'

/**
 *前置守卫
 *
*/

const whiteList = ['/login', '/404']
router.beforeEach(async(to, from, next) => {
  nprogress.start()
  if (store.getters.token) {
    // 存在token
    if (to.path === '/login') {
      // 跳转到主页
      next('/') // 中转到主页
      // next（地址）并没有执行后置守卫
      nprogress.done()
    } else {
      // 判断是否获取过资料
      if (!store.getters.userId) {
        const { roles } = await store.dispatch('user/getUserInfo')
        // console.log(roles.menus) // 数组 不确定 可能是8个 1个 0个
        // console.log(asyncRoutes) // 数组 8个
        const filterRoutes = asyncRoutes.filter(item => {
          // return true/false
          return roles.menus.includes(item.name)
        })
        // 筛选后的路由////////////////////////////////////////////////////////////////////////////444444
         // 筛选提交，添加到vuex中去！！！！！！！！！
        store.commit('user/setRoutes', filterRoutes)  
          
        // 添加动态路由信息到路由表
        router.addRoutes([...filterRoutes, { path: '*', redirect: '/404', hidden: true }]) 
        // router添加动态路由之后 需要转发一下
        next(to.path) // 目的是让路由拥有信息 router的已知缺陷
      } else {
        next() // 放过
      }
    }
  } else {
    // 没有token
    if (whiteList.includes(to.path)) {
      next()
    } else {
      next('/login') // 中转到登录页
      nprogress.done()
    }
  }
})
```

- 使用getters开放路由的访问信息-

```javascript
const getters = {
  sidebar: state => state.app.sidebar,
  device: state => state.app.device,
  token: state => state.user.token,
  userId: state => state.user.userInfo.userId,
  avatar: state => state.user.userInfo.staffPhoto, // 头像
  name: state => state.user.userInfo.username, // 用户名称
  routes: state => state.user.routes
}
export default getters

```

- `Layout/components/Sidebar/index`左侧菜单组件读取Vuex中的路由信息

```javascript
export default {
  components: { SidebarItem, Logo },
  computed: {
    ...mapGetters([
      'sidebar',
       'routes'
    ]),
    // 路由信息的计算属性
    // routes() {
    //   // 返回所有的路由信息
    //   return this.$router.options.routes
    // },
  }
}
```



### 退出登录重置路由

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677842226740-22a33f8b-07ef-4b0b-9355-c0ec534e054a.png#averageHue=%23c3daec&clientId=u7263e634-8cc4-4&from=paste&height=161&id=ud762b032&name=image.png&originHeight=322&originWidth=2080&originalType=binary&ratio=2&rotation=0&showTitle=false&size=63016&status=done&style=none&taskId=u9b5a91e3-3151-4f1d-a1ab-075e69da7a1&title=&width=1040)

- 退出登录时-重置路由-代码位置(**src/store/modules/user.js**)

```javascript
import { resetRouter } from '@/router'

// 退出登录的action
  logout(context) {
    context.commit('removeToken') // 删除token
    context.commit('setUserInfo', {}) // 设置用户信息为空对象
    // 重置路由
    resetRouter() 
  }
```



### 功能权限-按钮权限标识

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677842344977-b73028d0-80af-44c0-9e09-e8a9b67f3425.png#averageHue=%23ccdded&clientId=u7263e634-8cc4-4&from=paste&height=97&id=uadb0999b&name=image.png&originHeight=194&originWidth=2032&originalType=binary&ratio=2&rotation=0&showTitle=false&size=42103&status=done&style=none&taskId=u8d202f40-29f8-48c7-afee-311f8cdc3e8&title=&width=1016)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677842355723-0eff0601-376c-45cf-b42e-0ea5e93cbd57.png#averageHue=%23fdfcfc&clientId=u7263e634-8cc4-4&from=paste&height=78&id=ua2ff0d96&name=image.png&originHeight=156&originWidth=1764&originalType=binary&ratio=2&rotation=0&showTitle=false&size=31994&status=done&style=none&taskId=u415690ec-966e-428f-b4a6-f4a9c4b64be&title=&width=882)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677842380628-1434b24b-89e9-4c3e-bccf-68d32a813860.png#averageHue=%23fbfafa&clientId=u7263e634-8cc4-4&from=paste&height=213&id=u4d91064d&name=image.png&originHeight=426&originWidth=2108&originalType=binary&ratio=2&rotation=0&showTitle=false&size=122946&status=done&style=none&taskId=ubc8ca504-c1d6-4fc4-ab16-f29be8087b1&title=&width=1054)

### 自定义指令应用功能权限

- 自定义指令- 作用在按钮上-所有的按钮都可以直接使用 

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677842430909-125e2e00-04ad-42f5-80c4-613e011df381.png#averageHue=%23b7cadf&clientId=u7263e634-8cc4-4&from=paste&height=105&id=u4b9311f4&name=image.png&originHeight=210&originWidth=2000&originalType=binary&ratio=2&rotation=0&showTitle=false&size=52947&status=done&style=none&taskId=u661c63ae-4204-423a-bfce-79d3b5f05e7&title=&width=1000)

- 封装自定义指令-代码位置(**src/main.js**)

```javascript
// 封装自定义指令 用来控制操作权
Vue.directive('permission', {
  // 会在指令作用的元素插入到页面完成以后触发
  inserted(el, binding) {
    // el 指令作用的元素的dom对象 binding是表达式的信息
    // console.log(el)
    const points = store.state.user.userInfo?.roles?.points || [] // 当前用户信息的操作权
    // points中是否有add-employee
    if (!points.includes(binding.value)) {
      // 不存在就要删除或者禁用
      // el.remove() // 删除元素
         el.disabled = true
      // 线上的权限数据和线下的代码进行对应
    }
  }

})
```

- 应用自定义指令

```html
<el-button v-permission="'add-employee'" size="mini" type="primary" @click="$router.push('/employee/detail')">添加员工</el-button>

```





### echarts图表的应用

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677843414405-1bc80c4f-0036-41d0-a343-345acca4be97.png#averageHue=%23cbefed&clientId=u6a4ee274-1cea-4&from=paste&height=265&id=u96585014&name=image.png&originHeight=530&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2718596&status=done&style=none&taskId=u8859e143-2236-4f0b-9ce5-861d6faeeb5&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677843432463-2fbfe16a-ce1b-4fb5-b844-aa0cd09b394c.png#averageHue=%2396bddc&clientId=u6a4ee274-1cea-4&from=paste&height=287&id=u0df0add9&name=image.png&originHeight=574&originWidth=1850&originalType=binary&ratio=2&rotation=0&showTitle=false&size=134460&status=done&style=none&taskId=u86f2fcd2-c05d-421c-bd42-e8de9e264e3&title=&width=925)

- 安装echarts包

```bash
$ npm i echarts 
$ yarn add echarts
```

- 放置两个图表的div，并给定高宽

```html
 <div class="chart">
    <!-- 图表 -->
    <div ref="social" style=" width: 100%; height:100% " />
</div>
  <div class="chart">
              <!-- 图表 -->
    <div ref="provident" style=" width: 100%; height:100% " />
  </div>
```

- 在mounted中初始化图表

```vue
<script>
import CountTo from 'vue-count-to'
import { mapGetters } from 'vuex'
import { getHomeData, getMessageList } from '@/api/home'
import * as echarts from 'echarts' // 引入所有的echarts
export default {
  components: {
    CountTo
  },
  data() {
    return {
      homeData: {}, // 存放首页数据的对象
      list: []
    }
  },
  // 计算属性
  computed: {
    ...mapGetters(['name', 'avatar', 'company', 'departmentName']) // 映射给了计算属性
  },
  watch: {  
    homeData() { // 监听 homeData 的变化
      // console.log(this.homeData) 获取数据之后设置图表
      // 设置图表
      this.social.setOption({
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: this.homeData.socialInsurance?.xAxis
        },
        yAxis: {
          type: 'value'
        },
        series: [
          {
            data: this.homeData.socialInsurance?.yAxis,
            type: 'line',
            areaStyle: {
              color: '#04c9be' // 填充颜色
            },
            lineStyle: {
              color: '#04c9be' // 线的颜色
            }
          }
        ]
      })
      this.provident.setOption({
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: this.homeData.providentFund?.xAxis
        },
        yAxis: {
          type: 'value'
        },
        series: [
          {
            data: this.homeData.providentFund?.yAxis,
            type: 'line',
            areaStyle: {
              color: '#04c9be' // 填充颜色
            },
            lineStyle: {
              color: '#04c9be' // 线的颜色
            }
          }
        ]
      })
    }
  },
  created() {
    this.getHomeData()
    this.getMessageList()
  },
  mounted() {
    // 获取展示的数据 设置给图表
    // 监听homeData的变化
    this.social = echarts.init(this.$refs.social) // 初始化echart
    // data中没有声明 不是响应式
    this.provident = echarts.init(this.$refs.provident)
  },
  methods: {
    async getHomeData() {
      this.homeData = await getHomeData()
    },
    async getMessageList() {
      this.list = await getMessageList()
    }
  }
}
</script>
```

> 这里为什么要用watch，因为获取数据在created，初始化图表在mounted，执行mouted时，数据并不能保证能够获取到，所以采用获取watch监听数据变化，只要数据变化，就设置图表的options


> 为什么 this.social和this.provident 并没有在data中声明，注意，在data中声明的表示它是响应式数据，即它的变化要引起template模板的刷新，但是这里我们只是记录一下当前图表的实例，实例本身会有setOption来影响图表的动态渲染，所以这里并没有必要在data中声明这两个变量

**echarts图表的按需导入**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677843874842-3c458a40-1b7f-4de7-88e3-7a23abe03dcb.png#averageHue=%23cbefed&clientId=u6a4ee274-1cea-4&from=paste&height=265&id=u9430f006&name=image.png&originHeight=530&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2718596&status=done&style=none&taskId=u1a4e09b4-7088-4f5e-9419-926538f5fc8&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677843886811-efc90a51-99f2-4921-8c52-554a862bfe3c.png#averageHue=%2382594b&clientId=u6a4ee274-1cea-4&from=paste&height=253&id=ue7b77bea&name=image.png&originHeight=506&originWidth=1422&originalType=binary&ratio=2&rotation=0&showTitle=false&size=74387&status=done&style=none&taskId=ubaa738ab-9330-4e7c-af81-aaf4fa5041d&title=&width=711)

- echarts图表的按需导入

```javascript
import * as echarts from 'echarts/core' // 引入核心包
import { LineChart } from 'echarts/charts' // 引入折线图
import { GridComponent } from 'echarts/components' // 引入组件
import { CanvasRenderer } from 'echarts/renderers'
echarts.use([
  LineChart,
  GridComponent,
  CanvasRenderer
])
```


### 路由模式-将路由改成history模式

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677843996006-6a4c7eba-43a4-46e4-8594-d6e840c2fde0.png#averageHue=%23fdfbfb&clientId=u6a4ee274-1cea-4&from=paste&height=234&id=u8549b434&name=image.png&originHeight=468&originWidth=2202&originalType=binary&ratio=2&rotation=0&showTitle=false&size=108281&status=done&style=none&taskId=u6a32e7fa-71df-4ce7-b968-033ff6063e1&title=&width=1101)

- hash模式带#，#后面的地址变化不会引起页面的刷新
- history没有#，地址变化会引起页面刷新，更符合页面地址的规范（开发环境不刷新-webpack配置）

- 将路由模式修改成history模式-代码位置(**src/router/index.js)**

```javascript
const createRouter = () => new Router({
  mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }), // 管理滚动行为 如果出现滚动 切换就让 让页面回到顶部
  routes: constantRoutes // 默认引入静态路由
})
```


### 打包性能分析

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677844109668-4e5f5692-e760-4799-8956-cacd246c1d45.png#averageHue=%23f8f8db&clientId=u6a4ee274-1cea-4&from=paste&height=114&id=ue6328082&name=image.png&originHeight=228&originWidth=1990&originalType=binary&ratio=2&rotation=0&showTitle=false&size=40337&status=done&style=none&taskId=u35846a2a-c930-410e-bd0e-9163cd4374b&title=&width=995)

- 打包分析代码

```bash
$ npm run preview -- --report
```

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677860576748-d3af499b-ca5c-404f-94a7-e292c86d15a9.png#averageHue=%23c7e59a&clientId=u0f540d11-b7d4-4&from=paste&height=258&id=uc335b4cd&name=image.png&originHeight=516&originWidth=954&originalType=binary&ratio=2&rotation=0&showTitle=false&size=381245&status=done&style=none&taskId=u9b2b4566-a99b-4c00-9dda-afa6f7785e1&title=&width=477)

- 去除main.js中对于mock.js的引用

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677860606834-11a34fdd-46a1-4f2a-b8c7-3cecfde531a5.png#averageHue=%234b4b4b&clientId=u0f540d11-b7d4-4&from=paste&height=112&id=u9136f2ff&name=image.png&originHeight=224&originWidth=820&originalType=binary&ratio=2&rotation=0&showTitle=false&size=37215&status=done&style=none&taskId=u7fae7a2a-a05c-4803-95b7-707b1d24b7c&title=&width=410)

### CDN加速

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677860649908-9d614b46-8fa1-41f2-b132-6218fe6fac55.png#averageHue=%23cbe4a5&clientId=u0f540d11-b7d4-4&from=paste&height=327&id=u75f63725&name=image.png&originHeight=653&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3349503&status=done&style=none&taskId=uc06712a7-08ba-497e-b03c-631e4e09408&title=&width=640)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677860641069-726b7fb7-2724-4e23-b574-08b82fc9eb8e.png#averageHue=%23cadeee&clientId=u0f540d11-b7d4-4&from=paste&height=128&id=u07a5e314&name=image.png&originHeight=256&originWidth=1288&originalType=binary&ratio=2&rotation=0&showTitle=false&size=27504&status=done&style=none&taskId=u25dc44c1-df7f-484b-936f-34eca798b29&title=&width=644)

> 将几个比较大的多在打包时排除，这样可以缩小整体打包的大小，保证js的加载速度，排除的包采用cdn的方式用外链去引入，cdn本名为分发服务器，意为更近的访问区间更快的访问速度将所需要的文件返回给客户端

- webpack排除打包-代码位置(**vue.config.js**)

```javascript
 configureWebpack: {
    // provide the app's title in webpack's name field, so that
    // it can be accessed in index.html to inject the correct title.
    name: name,
    resolve: {
      alias: {
        '@': resolve('src')
      }
    },
    // 配置需要排出的包
    externals: {
      'vue': 'Vue',
      'element-ui': 'ELEMENT',
      'cos-js-sdk-v5': 'COS'
    }
  },
```

- 在html中采用外链引入排除的文件-代码位置(**public/index.html**)

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="icon" href="<%= BASE_URL %>favicon.ico">
    <title><%= webpackConfig.name %></title>
     <!-- css并不阻塞页面的渲染 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/theme-chalk/index.min.css" rel="stylesheet">
        
  </head>
  <body>
    <noscript>
      <strong>We're sorry but <%= webpackConfig.name %> doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
    </noscript>
    <div id="app"></div>
    <!-- built files will be auto injected -->
        <!-- 等待页面加载完成加载 js 外链的方式引入项目中-->
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/2.6.14/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.13/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js" ></script>

  </body>
</html>

```



## 一：项目打包-安装nginx

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861215372-0e121332-d5bd-4a39-90da-cf8bd02ad3bb.png#averageHue=%23fdfdfd&clientId=u0f540d11-b7d4-4&from=paste&height=304&id=ue9acc474&name=image.png&originHeight=608&originWidth=2066&originalType=binary&ratio=2&rotation=0&showTitle=false&size=84252&status=done&style=none&taskId=ua1ea17a8-fc55-403a-b0a8-eed1a691c18&title=&width=1033)

- 执行打包命令

```bash
$ npm run build:prod
$ yarn build:prod
```

> 得到dist文件包

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861289047-75b91eb0-124e-4e57-af00-fb10f254f90d.png#averageHue=%231e2b35&clientId=u0f540d11-b7d4-4&from=paste&height=121&id=ua0d8f63f&name=image.png&originHeight=597&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3062262&status=done&style=none&taskId=u001517dc-4838-4bb6-8f6d-2355386d9d5&title=&width=260)

- 安装nginx-mac

```bash
$ brew install nginx  # mac安装nginx
```

- 查看版本-mac

```bash
$ nginx -v  # 查看版本
```

- 查看nginx-mac

```bash
$ brew info nginx #查看nginx
```

- nginx-windows版本

> 直接解压就可以直接使用

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861435558-15cfdbf2-3a3a-4c7d-b036-8ed7d3c6a2ad.png#averageHue=%23fbfbfb&clientId=u0f540d11-b7d4-4&from=paste&height=190&id=u778fd62c&name=image.png&originHeight=380&originWidth=862&originalType=binary&ratio=2&rotation=0&showTitle=false&size=38390&status=done&style=none&taskId=ub5348533-01e7-4082-9f3f-9c137c8655b&title=&width=431)


注意：**mac安装**可能遇到的问题

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861482662-8497aa6d-35f2-4a64-b6a5-828135ac94a9.png#averageHue=%23173c46&clientId=u0f540d11-b7d4-4&from=paste&height=97&id=ue091659c&name=image.png&originHeight=194&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=995160&status=done&style=none&taskId=u48ee8f82-60c6-447a-aaf4-3374a861d86&title=&width=640)
遇到某个包发生错误，直接使用brew安装这个包，再安装nginx

```bash
$ brew install pcre2  # 安装出错的包
$ brew install nginx  # 安装nginx
```

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861513259-ad09f8a0-71a2-427f-817b-40af94130ed2.png#averageHue=%233b4349&clientId=u0f540d11-b7d4-4&from=paste&height=122&id=u48f6e853&name=image.png&originHeight=244&originWidth=1280&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1251622&status=done&style=none&taskId=u5b127742-cc2b-449d-bf4b-20b2a721e45&title=&width=640)
遇到这个错误，可以直接执行该命令，安装对应的工具，再安装nginx

```bash
$  xcode-select --install  # 安装对应工具
$  brew install nginx  # 安装nginx
```


### mac/windows环境下nginx部署启动项目

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861587484-c1541d97-1b35-4597-b336-fd9b797de83a.png#averageHue=%239dc2df&clientId=u0f540d11-b7d4-4&from=paste&height=65&id=u271b3125&name=image.png&originHeight=130&originWidth=1742&originalType=binary&ratio=2&rotation=0&showTitle=false&size=31679&status=done&style=none&taskId=ud8b2cf52-5929-4627-aaea-ddc83f960dc&title=&width=871)

- mac查看nginx的相关目录

```bash
brew info nginx #查看nginx

```

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861609109-f1747f8c-ea6b-4808-a5f1-a7972c82a332.png#averageHue=%23191919&clientId=u0f540d11-b7d4-4&from=paste&height=360&id=u263cc82e&name=image.png&originHeight=720&originWidth=998&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2879691&status=done&style=none&taskId=ub82426c4-8e6f-4c9e-9370-e74b022a2ac&title=&width=499)

mac-nginx安装目录-/opt/homebrew/Cellar/nginx/1.23.3 
mac-配置文件路-/opt/homebrew/etc/nginx/nginx.conf 

- 将打包的文件放置到安装目录/html下

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861665031-da2a64e6-7b58-4b59-8652-f38284a9215f.png#averageHue=%23f5f5f5&clientId=u0f540d11-b7d4-4&from=paste&height=192&id=u571941af&name=image.png&originHeight=720&originWidth=1133&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3269115&status=done&style=none&taskId=u0e93a61d-0fc7-4206-9084-102defd7494&title=&width=302.5)

- mac-启动服务命令

```bash
$ /opt/homebrew/Cellar/nginx/1.23.3/bin/nginx #启动命令

```

- mac-重启服务

```bash
$ /opt/homebrew/Cellar/nginx/1.23.3/bin/nginx -s stop  #停止命令

```

> 注意： mac版本的nginx的默认端口为8080

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861743190-64ba2366-f63c-4566-bf73-eb4d1355ac1b.png#averageHue=%239aa8a3&clientId=u0f540d11-b7d4-4&from=paste&height=360&id=u9057323c&name=image.png&originHeight=720&originWidth=1206&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3479702&status=done&style=none&taskId=ud9b5b029-de3c-4b14-ad17-6a093462e8b&title=&width=603)

- 
- 
- 
- **windows版本启动服务**
- ![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861771519-bca919e2-2d6a-456e-bd44-c3143be8b611.png#averageHue=%23fdfcfa&clientId=u0f540d11-b7d4-4&from=paste&height=215&id=u1bb29196&name=image.png&originHeight=1070&originWidth=720&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3087736&status=done&style=none&taskId=ud3bf29f4-b08f-472e-b254-74e03f3bc35&title=&width=145)![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861787675-9dd348f5-86b5-4a6b-a0cb-b95740ba169d.png#averageHue=%23fafafa&clientId=u0f540d11-b7d4-4&from=paste&height=133&id=ue8a9d2bf&name=image.png&originHeight=380&originWidth=1614&originalType=binary&ratio=2&rotation=0&showTitle=false&size=61192&status=done&style=none&taskId=u6b6997bd-db6f-45a3-b3e2-2ed22ce2882&title=&width=565)
- windows下停止服务

```bash
$ ./nginx -s stop  #停止命令

```

注意: nginx默认的访问端口为80

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861833368-8a533b5b-35f7-498c-8041-1fb4f334f8e6.png#averageHue=%23557367&clientId=u0f540d11-b7d4-4&from=paste&height=360&id=u69ca2001&name=image.png&originHeight=720&originWidth=1257&originalType=binary&ratio=2&rotation=0&showTitle=false&size=3626818&status=done&style=none&taskId=u3d1bfd72-7fe8-47d3-9871-0618cbb5af0&title=&width=628.5)





### nginx解决history的404问题

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861855748-b9e3b549-1f04-4f89-a824-9c95f8d9a6af.png#averageHue=%23d5d8e3&clientId=u0f540d11-b7d4-4&from=paste&height=118&id=ua9d13a47&name=image.png&originHeight=236&originWidth=2134&originalType=binary&ratio=2&rotation=0&showTitle=false&size=66400&status=done&style=none&taskId=uadbbd4c3-450f-4d6f-b0f6-aa8339cd9c8&title=&width=1067)

- 修改mac-windows配置文件

```bash
location / {
   try_files $uri $uri/ /index.html;
}
```

> 设置不论请求什么地址，都返回index.html

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861939613-eba82e02-4e61-47a6-9bdc-e63290fbf604.png#averageHue=%23030303&clientId=u0f540d11-b7d4-4&from=paste&height=32&id=u6dd0b12f&name=image.png&originHeight=64&originWidth=366&originalType=binary&ratio=2&rotation=0&showTitle=false&size=4911&status=done&style=none&taskId=u69e55578-dd36-4974-a0c8-ffbf6e32eb8&title=&width=183)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861958095-3583ae30-2f69-4fd4-a676-951bd60286b9.png#averageHue=%23f7f7f7&clientId=u0f540d11-b7d4-4&from=paste&height=360&id=u5455ae9a&name=image.png&originHeight=720&originWidth=930&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2683533&status=done&style=none&taskId=udcb50778-09a1-4103-974d-89492babe6d&title=&width=465)
**windows配置文件**
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677861973536-3b3ed9fd-bb6f-4d47-8638-42e60e661062.png#averageHue=%23fcfcfc&clientId=u0f540d11-b7d4-4&from=paste&height=483&id=u67d37f66&name=image.png&originHeight=966&originWidth=720&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2787618&status=done&style=none&taskId=u8bcf6c8e-1962-4663-927c-0c23c1a59cd&title=&width=360)

- mac重启服务

```bash
$ /opt/homebrew/Cellar/nginx/1.23.3/bin/nginx -s reload  #重启
```

- windows重启服务

```bash
$ ./nginx -s reload  #重启
```


### nginx配置代理解决生产环境跨域问题

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677862046625-2fba1cae-6d0b-4edd-91e9-ed18094987d3.png#averageHue=%23cdcbcb&clientId=u0f540d11-b7d4-4&from=paste&height=244&id=ua9c9499a&name=image.png&originHeight=488&originWidth=1882&originalType=binary&ratio=2&rotation=0&showTitle=false&size=144717&status=done&style=none&taskId=uc6be76e8-33b0-436e-9cbf-c9c22416db6&title=&width=941)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677862058407-f6b3725c-a57c-4711-acff-3088574d814b.png#averageHue=%23fdfdfd&clientId=u0f540d11-b7d4-4&from=paste&height=270&id=uf3364958&name=image.png&originHeight=540&originWidth=1918&originalType=binary&ratio=2&rotation=0&showTitle=false&size=53889&status=done&style=none&taskId=uda212cc3-d7e4-47b7-83bf-5b394037c9d&title=&width=959)

- nginx解决生产环境跨域

![image.png](https://cdn.nlark.com/yuque/0/2023/png/8435673/1677862085701-af444e51-9d9a-459c-b155-d852fa19a98b.png#averageHue=%23b3cfe6&clientId=u0f540d11-b7d4-4&from=paste&height=86&id=u408d2eba&name=image.png&originHeight=172&originWidth=1286&originalType=binary&ratio=2&rotation=0&showTitle=false&size=23695&status=done&style=none&taskId=u93f5218b-6b17-4370-8202-2a8e07430b9&title=&width=643)

- 修改配置文件

```bash
location /prod-api  {
  proxy_pass https://heimahr-t.itheima.net;
}
```

- mac重启服务

```bash
$ /opt/homebrew/Cellar/nginx/1.23.3/bin/nginx -s reload  #重启
```

- windows重启服务

```bash
$ ./nginx -s reload  #重启
```





## 二：在nodejs环境中应用并代理跨域

**`目标`**将打包好的代码打包上线，并在nodejs中代理跨域

### 使用koa框架部署项目

> 到现在为止，我们已经完成了一个前端工程师的开发流程，按照常规的做法，此时，运维会将我们的代码部署到阿里云的ngix服务上，对于我们而言，我们可以将其部署到本机的nodejs环境中

部署 自动化部署 /手动部署

第一步，建立web服务文件夹  **`hrServer`**

```bash 
$ mkdir hrServer #建立hrServer文件夹 
```

第二步，在该文件夹下，初始化npm

```bash
$ npm init -y
```

第三步，安装服务端框架koa(也可以采用express或者egg)

```bash
$ npm i koa koa-static
```

第四步，拷贝上小节打包的dist目录到**`hrServer/public`**下

第五步，在根目录下创建app.js，代码如下

```js
const Koa  = require('koa')  // 引入Koa包
const serve = require('koa-static');

const app = new Koa();  // 实例化一个web服务
app.use(serve(__dirname + "/public")); //将public下的代码静态化
app.listen(3333, () => {
     console.log('人资项目启动')
})
```

> node app
>
> 此时，我们可以访问，http://localhost:3333

页面出来了

### 解决history页面404访问问题

但是，此时存在两个问题，

1. **当我们刷新页面，发现404**

>   这是因为我们采用了history的模式，地址的变化会引起服务器的刷新，我们只需要在app.js对所有的地址进行一下处理即可

安装 koa中间件 

```bash 
$ npm i koa2-connect-history-api-fallback #专门处理history模式的中间件
```

**注册中间件**

```js
const Koa  = require('koa')
const serve = require('koa-static');
const  { historyApiFallback } = require('koa2-connect-history-api-fallback');
const path = require('path')
const app = new Koa();
// 这句话 的意思是除接口之外所有的请求都发送给了 index.html
app.use(historyApiFallback({      //应该先使用 处理访问的中间件 再使用静态化服务
     whiteList: ['/prod-api']  //prod-api代理跨域的问题  表示不要帮我处理 /prod-api 由自己处理
 }));  // 这里的whiteList是 白名单的意思
app.use(serve(__dirname + "/public")); //将public下的代码静态化

app.listen(3333, () => {
      console.log('人资项目启动http://localhost:3333')
})
```

### 解决生产环境跨域问题

1. 当点击登录时，发现接口404

>   前面我们讲过，vue-cli的代理只存在于开发期，当我们上线到node环境或者ngix环境时，需要我们再次在环境中代理

在nodejs中代理

安装跨域代理中间件

```bash
$ npm i koa2-proxy-middleware
```

配置跨越代理

```js
const Koa = require('koa')
const serve = require('koa-static');
const { historyApiFallback } = require('koa2-connect-history-api-fallback');
const proxy = require('koa2-proxy-middleware')
const path = require('path')
const app = new Koa();

//注册跨域代理的中间件
app.use(proxy({
    targets: {
        // 代理哪个地址  代理以 '/prod-api'为开头的地址
        '/prod-api/(.*)': {
            target: 'https://heimahr.itheima.net/api', // 将以prod/api开头的内容代理到该地址  后端服务器地址
            changeOrigin: true,
            pathRewrite: {
                '/prod-api': ""
            }
        }
    }
}))

// 这句话 的意思是除接口之外所有的请求都发送给了 index.html
app.use(historyApiFallback({ //应该先使用 处理访问的中间件 再使用静态化服务
    whiteList: ['/prod-api'] // prod-api代理跨域的问题  表示不要帮我处理 /prod-api 由自己处理
})); // 这里的whiteList是 白名单的意思
app.use(serve(__dirname + "/public")); //将public下的代码静态化

app.listen(3333, () => {
    console.log('人资项目启动http://localhost:3333')
})
```

注意：这里之所以用了**pathRewrite**，是因为生产环境的请求基础地址是 **/prod-api**，需要将该地址去掉

此时，我们的项目就可以跨域访问了！

